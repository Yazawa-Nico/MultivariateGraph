<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap.min.css" type="text/css">
    <!-- 添加动画效果 -->
    <link rel="stylesheet" href="css/bootstrap/css/bootstrap-theme.min.css" type="text/css">
    <!-- jquery -->
    <link rel="stylesheet" href="css/jquery-ui.min.css" type="text/css">
    <!-- css文件 -->
    <link rel="stylesheet" href="css/Style(2).css" type="text/css">
<style>
.node--internal circle {
  fill: #555;
}

.node--internal text {
  text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
}
.links1 line {
  stroke: #999;
  stroke-opacity: 0.6;
}
.link {
  fill: none;
  stroke: #555;
  stroke-opacity: 0.4;
  stroke-width: 0.5px;
}
.nodes1 circle {
  fill:none;
  /*stroke: #fff;
  stroke-width: 0.5px;*/
}
.leaf circle {
  fill: #ff7f0e;
  /*fill-opacity: .2;*/
}
.aaa circle {
  fill: rgb(31, 119, 180);
  /*fill-opacity: .1;*/
  stroke: rgb(31, 119, 180);
  stroke-width: 0.5px;
}
text {
  font: 10px sans-serif;
  text-anchor: middle;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
<script src="mds2.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="d3-ellipse-force.js"></script>
<script src="js/D3.v4.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/conrec.js"></script>
<script src="js/bootstrap/bootstrap.min.js"></script>
<script src="js/stratum_list.js"></script>
<script type="text/javascript" src="d3-ForceEdgeBundling.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js "></script> 

<body>
  <div id = "all">
      <div id = "left_side">
      <div class='panel panel-default' style="width: 600px;height: 600px">
        <div class="panel-heading">GraphView 
        <button id="btngraph" style="width:70px;height:22px;margin-left:420px"><font size="2">Switch</font></button>
        </div>
        <div class="panel-body">
          <div id = "graph_view"></div>
        </div>
      </div>
      </div>

      <div id = "right_side">

      <div class='panel panel-default' style="width: 800px;height: 300px">
        <div class="panel-heading">TreeView</div>
        <div class="panel-body">
          <div id = "tree_view"></div>
        </div>
      </div>
      <div class='panel panel-default' style="width: 800px;height: 300px">
        <div class="panel-heading">SankyView
          <button id="btn1" style="width:70px;height:22px;margin-left:50px"><font size="2">TreeEdit</font></button>
          <button id="btnrandom" style="width:70px;height:22px"><font size="2">Random</font></button>
          <button style="width:70px;height:22px"><font size="2">Order_U</font></button>
          <button id="btn" style="width:70px;height:22px"><font size="2">Size</font></button>
          <button id="btnden" style="width:70px;height:22px"><font size="2">Value</font></button>
          <button id="btnuniform" style="width:70px;height:22px"><font size="2">Color_U</font></button>
          <button id="btncolormain" style="width:70px;height:22px"><font size="2">Majority</font></button>
          <button id="btntreemap" style="width:70px;height:22px"><font size="2">Treemap</font></button>
        </div>
        <div class="panel-body">
          <div id = "sanki_view"></div>
        </div>
      </div>

      </div>
  </div>
</body>

<script type="text/javascript">
  var svgw=document.getElementById("graph_view").offsetWidth,
      svgh=document.getElementById("graph_view").offsetHeight;
  var svgtw=document.getElementById("tree_view").offsetWidth,
      svgth=document.getElementById("tree_view").offsetHeight;
  var svgsw=document.getElementById("sanki_view").offsetWidth,
      svgsh=document.getElementById("sanki_view").offsetHeight;
  /*var svgmw=document.getElementById("mds_view").offsetWidth,
      svgmh=document.getElementById("mds_view").offsetHeight;
  var svgpw=document.getElementById("plot_view").offsetWidth,
      svgph=document.getElementById("plot_view").offsetHeight;*/

  var svggrapg = d3.select("#graph_view")
            .append("svg")
            .attr("width", svgw)
            .attr("height", svgh);
  var gwells = svggrapg.append("g").attr("transform", "translate("+svgw*0.025+","+svgh*0.025+")");
  var gwellsline2 = svggrapg.append("g");
  var gwellsline = svggrapg.append("g");
  var gwellsnode2 = svggrapg.append("g");
  var gwellsline3 = svggrapg.append("g");
  var gwellsnode3 = svggrapg.append("g");
  var gwellsnodesmall = svggrapg.append("g");
  var gwellsnodebig = svggrapg.append("g");

  var svgtree = d3.select("#tree_view")
            .append("svg")
            .attr("width", svgtw)
            .attr("height", svgth);
  var gwellstree = svgtree.append("g").attr("transform", "translate("+svgtw*0.05+","+svgth*0.05+")");
  var svgsanki = d3.select("#sanki_view")
            .append("svg")
            .attr("width", svgsw)
            .attr("height", svgsh);
  var gwellsanki = svgsanki.append("g");
  /*var svgmds = d3.select("#mds_view")
            .append("svg")
            .attr("width", svgmw)
            .attr("height", svgmh);
  var gwellsmds = svgmds.append("g");
  var svgplot = d3.select("#plot_view")
            .append("svg")
            .attr("width", svgpw)
            .attr("height", svgph);
  var gwellsplot = svgplot.append("g").attr("transform", "translate("+svgpw*0.1+","+svgph*0.1+")");*/

  var color = d3.scaleOrdinal(d3.schemeCategory10);
  var aroot;
  var pack = d3.pack()
    .size([svgw*0.95, svgh*0.95]);
  var centerarr = [];
  var _pie = d3.pie();
d3.json("flare1.json", function(error, root) {
  if (error) throw error;
  aroot = root;
  root1 = d3.hierarchy(root)
      .sum(function(d) { return d.size; })
      .sort(function(a, b) { return b.value - a.value; });
  flaredata = pack(root1).descendants();
  /*var node = gwells.selectAll(".node")
    .data(pack(root1).descendants())
    .enter().append("g")
      .attr("class", function(d) { return d.children ? "aaa" : "leaf node"; })
      .attr("fill-opacity", function(d) { return (d.value==1618||d.value==2254) ? 0.1 : 0.0; })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });*/

  /*node.append("title")
      .text(function(d) { return d.data.name + "\n" + format(d.value); });*/

  /*node.append("circle")
      .attr("r", function(d) { return d.r; });*/

  /*node.filter(function(d) { return !d.children; }).append("text")
      .attr("dy", "0.3em")
      .text(function(d) { return d.data.name.substring(0, d.r / 3); });*/

  console.log(flaredata);
  for(var i = 0;i < flaredata.length;i++){
    var acenter={"x":0,"y":0};
    acenter.x = flaredata[i].x;
    acenter.y = flaredata[i].y;
    centerarr.push(acenter);
  }
  console.log(centerarr);
});
d3.json("data3.json",function(error, json) {
  if (error) throw error;
  console.log(aroot);
  dataset = json;
  var attr = ["city","vip","sex","occupation","age","activity","date","n_comment","n_follower","area"];
  var ccc = 10000;
  var relation = new Array();
  var csvnodes = dataset.nodes;
  var csvlinks = dataset.links;
 // var reg = /^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;  
  var visited= new Array( csvnodes.length );
  var i=csvnodes.length;
  var j=csvlinks.length;
  var sankiwidth = 40;
  var sankistep = 132;
  var switchmark = 0;
  var attrmax = [30,1,1,4,3,4,15,6,6,6];
  var startred = d3.rgb(0,255,255);  
  var endblue = d3.rgb(0,0,255);      
  var flag11 = false,flag22 = false;  
  var flagc1 = false,flagc2 = false;
  var nowclick = 3;
  var middlenew = [];
  var colors = d3.interpolate(startred,endblue);
  var linearcolor = d3.scaleLinear()
        .domain([0, 1])  
        .range([0, 1]); 
  //console.log(csvlinks);
  while(ccc--){ relation[ccc] = new Array();}
  j=csvlinks.length;

  while(i--){ visited[i] = -1;}
  while(j--){ 
    //console.log(csvlinks[j].source);
    relation[csvlinks[j].source].push(csvlinks[j].target);
    //relation[csvlinks[j].target].push(csvlinks[j].source);
  }

  //构造不联通子图的数组/////////////////////////////////////////////////
  var graphs=[];
  var visited= new Array( csvnodes.length );
  var i=csvnodes.length;
  while(i--){ visited[i] = -1;}

  for(var j=0;j<csvnodes.length;j++)
  {

    if(visited[j]>0)continue;
    else
    {
      var graph=[];
      var duilie=[];
      visited[j]=1;
      duilie.push(j);
      while(duilie.length>0)
      {
        var temp= duilie.shift();
        graph.push(temp);
        for(var k=0; k< relation[temp].length; k++)
        {
          var lid=relation[temp][k];
          
          if(visited[lid] <0)
          {
            visited[lid] = 1;
            duilie.push(lid);
          }

        }
      }
      graphs.push(graph);
    }
  }
  console.log(graphs);
  console.log(csvnodes);
  var finalnodes = new Array();
  var cnt = 0;
  var graphnum=1;//暂定抽取第一的子图
  graphs.sort(function(a,b){return b.length-a.length;});
  
  //获取提取后的节点name合集finalnodes
  for(var k=0;k<graphnum;k++)
  {
    for(var q=0;q<graphs[k].length;q++)
    {
        var tempid=graphs[k][q];
        finalnodes.push(tempid);
    }
  }
  finalnodes.sort(function(a,b){return a - b;});
  //console.log(finalnodes);

  cnt = 0;
  var nnodes = new Array();
  var llinks = new Array();
for(var k=0;k<graphnum;k++){
  nnodes[k] = [];
  llinks[k] = [];
  cnt = 0;
  for (var i = 0;i < csvnodes.length; i++) {
    for ( var j = 0;j < graphs[k].length; j++){
      if(csvnodes[i].name == finalnodes[j]){
        nnodes[k][cnt] = new Array();
        nnodes[k][cnt] = csvnodes[i];    
        cnt++;
      }
    }
  }
}
  //console.log(nnodes);
for(var k=0;k<graphnum;k++){
  cnt = 0;
  for (var i = 0;i < csvlinks.length; i++) {
    var flag1 = 0;
    var flag2 = 0;
    for ( var j = 0;j < graphs[k].length; j++){
      if(csvlinks[i].source == graphs[k][j]){
        flag1 = 1;
      }
      if(csvlinks[i].target == graphs[k][j]){
        flag2 = 1;
      }      
    }
    if(flag1==1&&flag2==1){
    //如果一条边的source和target都在提取后的节点数组中 则提取这条边
        llinks[k][cnt] = new Array();
        llinks[k][cnt] = csvlinks[i];
        cnt++;
    }
  }
}

/*for(var k=0;k<graphnum;k++){
  for (var i = llinks[k].length - 1; i >= 0; i--) {
    var ss = llinks[k][i].source;
    var tt = llinks[k][i].target;
    llinks[k][i].source = indexOf(graphs[k],ss);
    llinks[k][i].target = indexOf(graphs[k],tt);
  }
}*/
  function indexOf(arr,item){
     return  arr.indexOf(item);
  }
  
  function addchildx(obj){
    if(obj.values == null)
      return;
    obj.children = obj.values;
    delete obj.values;
    for(var i= 0; i < obj.children.length;i++){
      addchildx(obj.children[i]);
    }
  }
for(var k=0;k<graphnum;k++){
  for(var i = 0;i < nnodes[k].length;i++){
    nnodes[k][i].id = i;
  }
}
  var cnt = 0;
  //console.log(nnodes);
  //console.log(llinks);
  
  var test = nnodes[0];
  var entries = d3.nest()
    .key(function(d) { return d.groupB; })
    .key(function(d) { return d.groupA; })
    .entries(test);
  
  var root1={values:0};
  root1.values = entries;

  addchildx(root1);

  var hie = d3.hierarchy(root1) ;
  var cnt =0;
  var procnt=[0,0,0,0,0,0];
  traverseTreeInit(hie);//初始化赋值
  hie.each(function(dd){//给非叶节点赋所属子图编号、所属子图大小
      var aleaf = dd.leaves();
      if(dd.depth==0)
        dd.children = dd.children.slice(0,5);
      if(dd.height!=0&&dd.depth!=0)
        if(dd.children.length>=10)
          dd.children = dd.children.slice(0,10);
      dd.graphcnt = aleaf[0].data.graphcnt;
      dd.graphid = aleaf[0].data.graphid;
    });
  /*traverseTreePointInit2(hie);
  traverseTreePointInit3(hie);
  traverseTreePointInit3(hie);*/
  console.log(procnt);
  cnt=0;
  hie.each(function(d){
    d.visit = false;
    d.id = cnt;
    if(!d.children){
      d.links = [];
    }
    cnt++;
  });

  //////各属性分别生成切层///////////////////////
  find_cut(hie,"city",0);
  find_cut(hie,"vip",1);
  find_cut(hie,"sex",2);
  find_cut(hie,"occupation",3);
  find_cut(hie,"age",4);
  find_cut(hie,"activity",5);
  find_cut(hie,"date",6);
  find_cut(hie,"n_comment",7);
  find_cut(hie,"n_follow",8);
  find_cut(hie,"area",9);

  /////属性分配控制数组////////////////////////
  var attrcontrol = [];
  for(var i = 0;i < attr.length;i++){
    attrcontrol[i] = [0];
    if(i==0){
      for(var j = 0;j < 36;j++){
        attrcontrol[i].push(1.0*(j+1)/36);
      }
    }
    else if(i==1){
      attrcontrol[i] = [0,0.8];
    }
    else if(i==2){
      attrcontrol[i] = [0,0.5];
    }
    else if(i==3){
      attrcontrol[i] = [0,0.5];
    }
    else if(i==4){
      attrcontrol[i] = [0,0.3,0.7,0.9,0.1];
    }
    else if(i==5){
      attrcontrol[i] = [0,0.25,0.45,0.65,0.835];
    }
    else if(i==6){
      attrcontrol[i] = [0,0.2];
      for(var j = 1;j < 15;j++){
        attrcontrol[i].push(0.2+0.8*(j+1)/15);
      }
    }
    else if(i==7){
      attrcontrol[i] = [0,0.3,0.5,0.7,0.8,0.9,0.95];
    }
    else if(i==8){
      attrcontrol[i] = [0,0.3,0.5,0.7,0.8,0.9,0.95];
    }
    else if(i==9){
      for(var j = 0;j < 7;j++){
        attrcontrol[i].push(1.0*(j+1)/7);
      }
    }
  }
  
  console.log(attrcontrol);

  //////根据控制数组生成属性////////////////////////
  /*hie.each(function(d){
    if(d.height == 0){
      for(var i=0;i < attr.length;i++){
        var randvalue = Math.random();
        var value1 = 0;
        for(var j = 0;j < attrcontrol[i].length;j++){
          if(randvalue < attrcontrol[i][j])
            value1 = j;
        }
    //if(i==0)
      //d.data.city = value1;
    if(i==1)
      d.data.vip = value1;
    else if(i==2)
      d.data.sex = value1;
    else if(i==3)
      d.data.profession = value1;
    else if(i==4)
      d.data.age = value1;
    else if(i==5)
      d.data.active = value1;
    else if(i==6)
      d.data.data = value1;
    else if(i==7)
      d.data.concern = value1;
    else if(i==8)
      d.data.beconcern = value1;
    //else if(i==9)
      //d.data.area = value1;

      }
    }
  });*/


  var drawA = true;
  var randdata = [];
  var markcolor = [];
  var circlex = [];
  var circley = [];
  var circler = []; 
  var circlecnt = []; 
  var annulusx = [];
  var annulusy = [];
  var annulusr = [];
  var annuluscnt = [];
  var cutnow = [];
  var cutnowA = [];
  for(var ci = 0;ci < attr.length+1;ci++){
    cutnow[ci] = [];
    cutnowA[ci] = [];
    circlex[ci] = [];
    circley[ci] = [];
    circler[ci] = []; 
    circlecnt[ci] = []; 
    annulusx[ci] = [];
    annulusy[ci] = [];
    annulusr[ci] = [];
    annuluscnt[ci] = [];
  }


  for(var i = 0;i < attr.length+1;i++){
    randdata[i] = [];
    markcolor[i] = [];
  }

  for(var i = 0;i < 5000;i++){
    randdata[1][i] = [0.7,0.3];
    var rand1 = Math.random();
    var rand2 = Math.random();
    for(var ii = 0;ii < randdata[1][i].length;ii++){
                  randdata[1][i][ii] += rand1*0.6;
                  randdata[1][i][ii] -= rand2*0.6;
                }
    //randdata[1][i].sort(function(){ return 0.5 - Math.random() });
  }

  for(var i = 0;i < 5000;i++){
    randdata[2][i] = [0.5,0.5];
    
    for(var ii = 0;ii < randdata[2][i].length;ii++){
                var rand1 = Math.random();
                  var rand2 = Math.random();
                  randdata[2][i][ii] += rand1*0.3;
                  randdata[2][i][ii] -= rand2*0.3;
                }
    randdata[2][i].sort(function(){ return 0.5 - Math.random() });
  }


  for(var i = 0;i < 5000;i++){
    if(i<=15)
    {
        randdata[3][i] = [0.65,0.25,0.05,0.025,0.025];
        var rand1 = Math.random();
        var rand2 = Math.random();
        for(var ii = 0;ii < randdata[3][i].length;ii++){
                      randdata[3][i][ii] += rand1*0.1;
                      randdata[3][i][ii] -= rand2*0.1;
                    }
        randdata[3][i].sort(function(){ return 0.5 - Math.random() });
    }
    else
    {
      randdata[3][i]=randdata[3][i%15];
    }
  }

  for(var i = 0;i <5000;i++){
    if(i<=15)
    {
        randdata[4][i] = [0.6,0.2,0.1,0.1];
        var rand1 = Math.random();
        var rand2 = Math.random();
        for(var ii = 0;ii < randdata[4][i].length;ii++){
                      randdata[4][i][ii] += rand1*0.2;
                      randdata[4][i][ii] -= rand2*0.2;
                    }
        randdata[4][i].sort(function(){ return 0.5 - Math.random() });
    }
    else
    {
      randdata[4][i]=randdata[4][i%15];
    }
  }

  for(var i = 0;i <5000;i++){
    if(i<=15)
    {
        randdata[5][i] = [0.5,0.2,0.1,0.1,0.1];
        var rand1 = Math.random();
        var rand2 = Math.random();
        for(var ii = 0;ii < randdata[5][i].length;ii++){
                      randdata[5][i][ii] += rand1*0.2;
                      randdata[5][i][ii] -= rand2*0.2;
                    }
        randdata[5][i].sort(function(){ return 0.5 - Math.random() });
        randdata[5][i][0] = 0;
    }
    else
    {
      randdata[5][i]=randdata[5][i%15];
    }
  }

  for(var i = 0;i <1000;i++){
    if(i<=15){
    randdata[6][i] = [0.2,0.15,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05];
    var rand1 = Math.random();
    var rand2 = Math.random();
    for(var ii = 0;ii < randdata[6][i].length;ii++){
                  randdata[6][i][ii] += rand1*0.2;
                  randdata[6][i][ii] -= rand2*0.2;
      }
      randdata[6][i].sort(function(){ return 0.5 - Math.random() });
      randdata[6][i][4] = 0;
      randdata[6][i][8] = 0;
      randdata[6][i][11] = 0;
      randdata[6][i][12] = 0;
      randdata[6][i][5] = 0;
    }
    else
    {
      randdata[6][i]=randdata[6][i%15];
    }
  }

  for(var i = 0;i <1000;i++){
    if(i<=15){
    randdata[7][i] = [0.3,0.2,0.2,0.1,0.1,0.05,0.05];
    var rand1 = Math.random();
    var rand2 = Math.random();
    for(var ii = 0;ii < randdata[7][i].length;ii++){
                  randdata[7][i][ii] += rand1*0.21;
                  randdata[7][i][ii] -= rand2*0.21;
                }
      randdata[7][i].sort(function(){ return 0.5 - Math.random() });
      randdata[7][i][4] = 0;
      randdata[6][i][6] = 0;
    }
    else
    {
      randdata[7][i]=randdata[7][i%15];
    }
  }

  for(var i = 0;i <1000;i++){
    if(i<=15){
    randdata[8][i] = [0.3,0.2,0.2,0.1,0.1,0.05,0.05];
    var rand1 = Math.random();
    var rand2 = Math.random();
    for(var ii = 0;ii < randdata[8][i].length;ii++){
                  randdata[8][i][ii] += rand1*0.12;
                  randdata[8][i][ii] -= rand2*0.12;
                }
    randdata[8][i].sort(function(){ return 0.5 - Math.random() });
    randdata[8][i][4] = 0;
    randdata[8][i][6] = 0;
    }
    else
    {
      randdata[8][i]=randdata[8][i%15];
    }
  }

  for(var i = 0;i <1000;i++){
    if(i<=15){
    randdata[9][i] = [0.16,0.16,0.16,0.16,0.16,0.16,0.16];
    
    for(var ii = 0;ii < randdata[9][i].length;ii++){
                  var rand1 = Math.random();
                  var rand2 = Math.random();
                  randdata[9][i][ii] += rand1*0.15;
                  randdata[9][i][ii] -= rand2*0.15;
                }
    randdata[9][i].sort(function(){ return 0.5 - Math.random() });
    randdata[9][i][2] = 0;
    randdata[9][i][6] = 0;
    }
    else
    {
      randdata[9][i]=randdata[9][i%15];
    }
  }

  for(var i = 0;i <1000;i++){
    if(i<=15){
    randdata[10][i] = [0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1];
    
    for(var ii = 0;ii < randdata[10][i].length;ii++){
                  var rand1 = Math.random();
                  var rand2 = Math.random();
                  randdata[10][i][ii] += rand1*0.15;
                  randdata[10][i][ii] -= rand2*0.15;
                }
    randdata[10][i].sort(function(){ return 0.5 - Math.random() });
    randdata[10][i][2] = 0;
    randdata[10][i][6] = 0;
    }
    else
    {
      randdata[10][i]=randdata[10][i%15];
    }
  }

  

  //////遍历links 将连线关系放入hie中/////////////
  var leavenodes = hie.leaves();
  console.log(llinks);
  console.log(leavenodes);
  for(var i = 0;i < csvlinks.length;i++){
    var findflag = 0;
    for(var j = 0;j < leavenodes.length;j++){
      for(var k = j+1;k < leavenodes.length;k++){
        //console.log(222);
        if(leavenodes[j].data.name == csvlinks[i].source&&leavenodes[k].data.name == csvlinks[i].target){
          //console.log(111);
          leavenodes[j].links.push(leavenodes[k].data.name);
          leavenodes[k].links.push(leavenodes[j].data.name);
          findflag = 1;
          break;
        }
      }
      if(findflag)
        break;
    }
  }
  /////将各属性的切层结果放入finalcut数组中///////////////////
  var finalcut = [];
  for(var j = 0 ; j<attr.length;j++){
    finalcut[j] = [];
    for(var i = 0 ; i<hie.children.length;i++){
      finalcut[j] = finalcut[j].concat(hie.children[i].cut[j]);
    }
  }
  finalcut[10] = finalcut[9];
  console.log(finalcut);

  hie.each(function(d){
  for(var ci = 0;ci < cutnow.length;ci++)
   for(var i = 0 ;i < finalcut[ci].length;i++){
     if(d.id == finalcut[ci][i]&&d.depth == 1)
     {
       var nowleaves = d.leaves();
       cutnow[ci].push(nowleaves[0].data.groupB);
     }
   }
  });

  hie.each(function(ddd){
       for(var ci = 0;ci < cutnowA.length;ci++)
      for(var ii = 0 ;ii < finalcut[ci].length;ii++){
        if(ddd.id == finalcut[ci][ii]&&ddd.depth == 2)
        {
          var nowleaves = ddd.leaves();
          cutnowA[ci].push(nowleaves[0].data.groupA);
        }
      }
  });




  /////////计算groupnodes和grouplinks并放入hie中/////////////
  console.log(hie);
  computer_graph(260, 300,290,hie);
  draw_graph(hie,1);

  circlex[10] = circlex[9];
  circley[10] = circley[9];
  circler[10] = circler[9];
  circlecnt[10] =circlecnt[9];
  annulusx[10] = annulusx[9];
  annulusr[10] = annulusr[9];
  annulusy[10] = annulusy[9];
  annuluscnt[10] = annuluscnt[9];
  console.log(circlex);
  console.log(annulusx);

  hie.each(function(d1){
    if(d1.children!=null){
      for(var i = 0;i < d1.children.length;i++){
        d1.children[i].gx = d1.groupnodes[i].x;
        d1.children[i].gy = d1.groupnodes[i].y;
      }
    }
  });

  ////////画树////////////////////////////////
  var tree = d3.cluster()
    .size([svgtw*0.9 , svgth*0.9]);

  var root2 = hie;

  tree(root2);
  //var color = d3.scaleOrdinal(d3.schemeCategory20);
  var link = gwellstree.selectAll(".link")
    .data(tree(root2).links())
    .enter().append("path")
      .attr("class", "link")
      .attr("d", d3.linkVertical()
          .x(function(d) { return d.x; })
          .y(function(d) { return d.y; }));
      

  var node = gwellstree.selectAll(".node")
      .data(root2.descendants())
    .enter().append("g")
      .attr("class", function(d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
      .attr("transform", function(d) { return "translate(" + d.x+ "," + d.y + ")"; })

/////////获取切层线属性////////////////////////////////
  var alllinedata = [];
  var middle = [];
  for(var i = 0;i < attr.length;i++){
    alllinedata[i] = [];
    middle[i] = [];
  }
  for(var i = 0;i < attr.length;i++){
    cnt = 0;
    while(1){
      traverseTreeCut(hie,i);
      if(cnt >=finalcut[i].length)
        break;
    }
  }
  console.log(alllinedata);
  console.log(middle);

//////////定义三种画线方式////////////////////////
 var lineFunction = d3.line()
         .x(function(d){return d.x;})
         .y(function(d){return d.y;})
         .curve(d3.curveStep);
         //.interpolate("step-before");

 var lineFunction1 = d3.line()
         .x(function(d){return d.x;})
         .y(function(d){return d.y;})
         .curve(d3.curveMonotoneY);
 var lineFunction2 = d3.line()
         .x(function(d) { return d.x; })
         .y(function(d) { return d.y; })
         .curve(d3.curveBasis);
 var d3line = d3.line()
         .x(function(d){return d.x;})
         .y(function(d){return d.y;})
         .curve(d3.curveBasis);

//////////树图中的点、线绘制//////////////////////////
for(var i = 0;i < alllinedata.length;i++){
     if(i==1) continue;
     if(i < 1) var ii = 1;
     else var ii = i; 
     gwellstree.append("path")
         .attr("d",lineFunction(alllinedata[i]))
         .attr("class","path"+i)
         .attr("stroke",color(i))
         .attr("stroke-width",1)
         .attr("fill","none")
         .attr("stroke-opacity",0.0);
     //var iii = i;
     svgtree.append("circle")
         .attr("fill","#CDC5BF")
         .attr("r",5)
         .attr("class","treecicle")
         .attr("id","treecircle"+i)
         .attr("cx",10 + 80 * (ii%5))
         .attr("cy",10 + parseInt(ii/5)*20)
         .datum(i); 
     
     svgtree.append("text")
         .attr("text-anchor","end")
         .attr("x",27 + 80 * (ii%5) + attr[i].length*2)
         .attr("y",13 + parseInt(ii/5)*20)
         .text(attr[i]);
     }
     gwellstree.append("path")
         .attr("d",lineFunction(alllinedata[9]))
         .attr("class","path"+10)
         .attr("stroke",color(10))
         .attr("stroke-width",1)
         .attr("fill","none")
         .attr("stroke-opacity",0.0);
     //var iii = i;
     svgtree.append("circle")
         .attr("fill","#CDC5BF")
         .attr("r",5)
         .attr("class","treecicle")
         .attr("id","treecircle"+10)
         .attr("cx",10)
         .attr("cy",10)
         .datum(10); 
     
     svgtree.append("text")
         .attr("text-anchor","end")
         .attr("x",26)
         .attr("y",13)
         .text("all");
    //var nowtreenode = 3;

///////注册点击node属性切换事件///////////////////////
  svgtree.selectAll(".treecicle")
        .on("click",function(d){
           if(d==1) d=10;
           nowclick = d;
           svgtree.selectAll(".piepath").remove();
           gwells.selectAll(".piepath").remove();
           //svggrapg.selectAll("#graphnodes0").remove();
           svggrapg.selectAll("#graphnodes1").remove();
           svggrapg.selectAll("#graphnodesB").remove();
           gwellsnodebig.selectAll(".piepath").remove();
           gwellsnodesmall.selectAll(".piepath").remove();
           gwellsline.selectAll(".piepath").remove();
           /*svgplot.selectAll(".plotnode").remove();
           svgplot.selectAll(".plotx").remove();
           svgplot.selectAll(".ploty").remove();*/

           draw_legend(d);

                  
           for(var i = 0; i < attr.length+1;i++){
               if(i==d){
                 svgtree.select("#treecircle"+i)
                        .transition()
                        .duration(100)
                        .attr("fill",color(d));
               }
               else{
                 svgtree.select("#treecircle"+i)
                        .transition()
                        .duration(100)
                        .attr("fill","#CDC5BF");
               }
           }

           if(d==4||d==5||d==6||d==7||d==8){
            svggrapg.selectAll("#graphnodes2")
                    .transition()
                    .duration(100)
                    .attr("fill", function(d) {
                         return colors(linearcolor(parseInt(Math.random()*5)/5));
                         //return (Math.random()>0.5)?"#00FFFF":"#000079" ;
                    });
           }
           else if(d==10){
           	svggrapg.selectAll("#graphnodes2")
                    .transition()
                    .duration(100)
                    .attr("fill", function(d) {
                         return color(parseInt(Math.random()*10));
                         //return (Math.random()>0.5)?"#00FFFF":"#000079" ;
                    });
           }
           else{
            svggrapg.selectAll("#graphnodes2")
                    .transition()
                    .duration(100)
                    .attr("fill", function(d) { 
                         return (Math.random()>0.5)?"#FF4500":"#1E90FF" ;
                    });

           }



           for(var i = 0;i < circley[d].length;i++){
                var arcdata = _pie(randdata[d][circlecnt[d][i]%15]);
                var arcPath = d3.arc()
                              .innerRadius(0)
                              .outerRadius(circler[d][i]);
                //svggrapg.append("g")
            if(circler[d][i] > 30){
                var maxii = 0,maxv = 0;
                for(var l = 0;l<randdata[d][i].length;l++){
                  if(randdata[d][i][l]>maxv){
                    maxv = randdata[d][i][l];
                    maxii = l;
                  }
                }
                markcolor[d].push(maxii);
                gwellsnodebig
                   .selectAll("path1")
                   .data(arcdata)
                   .enter()
                   .append("path")
                   .attr("class","piepath")
                   .attr("d", function(dd) {
                        return arcPath(dd);
                    })
                   .attr("stroke","none")
                   .attr("transform","translate("+(circlex[d][i])+","+(circley[d][i])+")")
                   //.attr("stroke-width","0.1px")
                   .attr("fill", function(dd, i) {
                    if(d==1||d==2)
                        {
                          if(i==0)
                                return "#1E90FF";
                            else
                                return "#FF4500";
                        }
                    else if(d == 4||d == 5||d==6||d == 7||d == 8)
                        return colors(linearcolor(i/attrmax[d]));
                      return color(i);
                    })
                 }
             else
              gwellsnodesmall
                   .selectAll("path1")
                   .data(arcdata)
                   .enter()
                   .append("path")
                   .attr("class","piepath")
                   .attr("d", function(dd) {
                        return arcPath(dd);
                    })
                   .attr("stroke","none")
                   .attr("transform","translate("+(circlex[d][i])+","+(circley[d][i])+")")
                   //.attr("stroke-width","0.1px")
                   .attr("fill", function(dd, i) {
                    if(d==1||d==2)
                        {
                          if(i==0)
                                return "#1E90FF";
                            else
                                return "#FF4500";
                        }
                    else if(d == 4||d == 5||d==6||d == 7||d == 8)
                        return colors(linearcolor(i/attrmax[d]));
                      return color(i);
                    })
            }
            if(drawA)
            for(var i = 0;i < annulusx[d].length;i++){
                var arcdata = _pie(randdata[d][annuluscnt[d][i]%15]);
                var arcPath = d3.arc()
                              .innerRadius(annulusr[d][i]*0.9)
                              .outerRadius(annulusr[d][i]);
                //svggrapg.append("g")
            if(annulusr[d][i]>30)
                gwellsnodebig
                   .selectAll("path2")
                   .data(arcdata)
                   .enter()
                   .append("path")
                   .attr("class","piepath")
                   .attr("d", function(dd) {
                        return arcPath(dd);
                    })
                   .attr("stroke","none")
                   .attr("transform","translate("+(annulusx[d][i])+","+(annulusy[d][i])+")")
                   //.attr("stroke-width","0.1px")
                   .attr("fill", function(dd, i) {
                    if(d==1||d==2)
                        {
                          if(i==0)
                                return "#1E90FF";
                            else
                                return "#FF4500";
                        }
                    else if(d == 4||d == 5||d==6||d == 7||d == 8)
                        return colors(linearcolor(i/attrmax[d]));
                      return color(i);
                    })
             else
              gwellsnodesmall
                   .selectAll("path2")
                   .data(arcdata)
                   .enter()
                   .append("path")
                   .attr("class","piepath")
                   .attr("d", function(dd) {
                        return arcPath(dd);
                    })
                   .attr("stroke","none")
                   .attr("transform","translate("+(annulusx[d][i])+","+(annulusy[d][i])+")")
                   //.attr("stroke-width","0.1px")
                   .attr("fill", function(dd, i) {
                    if(d==1||d==2)
                        {
                          if(i==0)
                                return "#1E90FF";
                            else
                                return "#FF4500";
                        }
                    else if(d == 4||d == 5||d==6||d == 7||d == 8)
                        return colors(linearcolor(i/attrmax[d]));
                      return color(i);
                    })
            }



             svgtree.selectAll(".path"+d)
                .transition()
                .duration(100)
                .attr("stroke-width",2)
                .attr("stroke-opacity",1);

             for(var ii = 0;ii< alllinedata.length+1;ii++){
                 if(ii!=d)
                   svgtree.selectAll(".path"+ii)
                    .transition()
                    .duration(100)
                    .attr("stroke-width",1)
                    .attr("stroke-opacity",0.1);
             }

             var cutres3 = [];
             var randcnt = 0;
               hie.each(function(d1){
                if(d1.children){ 
                 if(d1.children[0].children&&d1.parent&&d==10)
                  cutres3 = cutres3.concat(d1.cut[9]);
                else if(d1.children[0].children&&d1.parent)
                  cutres3 = cutres3.concat(d1.cut[d]);
                 }
               });
               console.log(cutres3);
               var cutcnt3 = [];
               hie.each(function(d1,ii){
                  var flag = 0;
                  for(var k = 0;k < cutres3.length;k++)
                      if(d1.id == cutres3[k]) flag=1;
                  //console.log(ido);
                  if(flag==1){
                    var leaf = d1.leaves();
                    //console.log(leaf);
                    for(var aa=0;aa < d1.leaves().length;aa++){
                     if(leaf[aa]!=null){
                      if(cutcnt3[leaf[aa].data.profession] == null)
                          cutcnt3[leaf[aa].data.profession] = 1;
                      else cutcnt3[leaf[aa].data.profession]++;
                    }
                  }

               var arcdata3 = _pie(randdata[d][d1.leaves().length%15]);
               randcnt++;
               var arcPath = d3.arc()
                               .innerRadius(0)
                               .outerRadius(Math.log(d1.leaves().length)*5);

               svgtree.append("g")
                   .selectAll("path")
                   .data(arcdata3)
                   .enter()
                   .append("path")
                   .attr("class","piepath")
                   .attr("d", function(dd) {
                        return arcPath(dd);
                    })
                   .attr("stroke","black")
                   .attr("transform","translate("+(d1.x+svgtw*0.05)+","+(d1.y+svgth*0.05)+")")
                   .attr("stroke-width","0.1px")
                   .attr("fill", function(dd, i) {
                    if(d == 1||d == 2)
                     {
                        return LightenDarkenColor(color(d),i*100);
                      }
                    else if(d==10)
                      return LightenDarkenColor(color(i),Math.random()*80);
                    else if(d==6)
                      return LightenDarkenColor(color(d),i*7);
                    else if(d == 4||d == 5||d == 7||d == 8)
                        return LightenDarkenColor(color(d),i*30);
                      return LightenDarkenColor(color(d),i*30);
                    })
               }
              });
               Switch();
         }); 
////////////////桑基图绘制/////////////////////
var alllines = [];
var allwidth = [];
var sankiorder = [0,1,2,3,4,5,6,7,8,9];
var cutcnt = [];
var sankimiddle = [];
var sankimiddleseed = [];
var sankialllines = [];
var sankialllinesseed = [];
var firstflag = true;
var sankiallwidth = [];
var sankiallwidthseed = [];
var sankicomdata = [];
var start_x = [[],[],[],[],[],[],[],[],[],[]];
computer_sanki(sankiorder,sankistep);
draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
console.log(sankimiddle);
////////////////排序数据处理///////////////////////////
//data_structure(sankimiddle,sankicomdata,sankiorder);
////////////////设置缩放////////////////////////////////
svgsanki
    .call(d3.zoom()
    .scaleExtent([0.5, 3])
    .on("zoom", zoomed));

  function zoomed() { 
    gwellsanki.attr("transform", d3.event.transform); 
  }
////////////////TreeEdit按钮////////////////////////////
  btn1.onclick = function(){
    var rorder = [];
    //console.log(cutcnt);
    var Positions = mds.classic(cutcnt);
    //console.log(Positions);
    var getorder = Positions.concat();
    function NumDescSort(a,b)
    {
        return a[0]-b[0];
    }
    getorder.sort(NumDescSort);
    //console.log(getorder);
    for(var i = 0; i < getorder.length ;i++){
      for(var j = 0; j < getorder.length ;j++){
        if(getorder[i]==Positions[j])
          rorder.push(j);
      }
    }
    console.log(rorder);
    sankiorder = rorder;
    computer_sanki(rorder,sankistep);
    draw_sanki(sankimiddle,sankialllines,sankiallwidth,rorder,sankistep,0);
  }
////////////////graphUniform按钮//////////////////////////
btngraph.onclick = function(){
	svggrapg.selectAll().remove();
	gwellsnodesmall.selectAll(".piepath").remove();
    gwellsnodebig.selectAll(".piepath").remove();
    gwellsline.selectAll(".links1").remove();
    gwellsline2.selectAll(".Bundling").remove();
    gwellsline3.selectAll(".links1").remove();
    svggrapg.selectAll("#graphnodesB").remove();
    svggrapg.selectAll("#graphnodes0").remove();
    svggrapg.selectAll("#graphnodes1").remove();
    svggrapg.selectAll("#graphnodes2").remove();
    svggrapg.selectAll(".legend").remove();
    svggrapg.selectAll(".legendtext").remove();
    switchmark++;
    if(switchmark%2==1)
	  draw_graph(hie,1);
    else{
  var newnode=[];
  var newlink=[];
  hie.each(function(d1){
    for(var i = 0;i < finalcut[0].length;i++){
      if(d1.id == finalcut[0][i]){

        var anode={"id":d1.id,"size":d1.leaves().length,"rx":d1.leaves().length,"ry":d1.leaves().length,"x":d1.gx,"y":d1.gy,"depth":d1.depth};
        newnode.push(anode);
      }
    }
  });
  
  var leaf1 = [];
  var leaf2 = [];
  var cntid = 0;
  for(var i = 0;i < newnode.length;i++){
    for(var j = i+1;j < newnode.length;j++){
       hie.each(function(d1){
         if(d1.id==newnode[i].id)
           leaf1 = d1.leaves();
         if(d1.id==newnode[j].id)
           leaf2 = d1.leaves();
         });
       var linkname = [];
       var valuecnt = 0;
       for(var k = 0;k < leaf1.length;k++){
            linkname = linkname.concat(leaf1[k].links);
          }
          dedupe(linkname);
       for(var k = 0;k < leaf2.length;k++){
            if(indexOf(linkname,leaf2[k].data.name) >= 0)
              valuecnt++;
          }
          if(valuecnt>0)
          {
            var alink={"id":cntid,"source":i,"target":j,"value":valuecnt};
            cntid++;
            newlink.push(alink);
          }
      }
    }
    for(var i = 0;i < newnode.length;i++){
    	newnode[i].id = i;
    }
    console.log(newnode);
    console.log(newlink);
    var fbundling = d3.ForceEdgeBundling().nodes(newnode).edges(newlink);
    var resultsccc = fbundling();
    console.log(resultsccc);
    for(var i = 0; i < resultsccc.length; i++){
       var linkccc = gwellsline2
       .append("path")
       .attr("d", lineFunction2(resultsccc[i]))
       .attr("class","Bundling")
       .attr("stroke-width", function(d) { 
        return Math.sqrt(resultsccc[i][0].size)*2;
      })
       .attr("stroke-opacity",0.2)
       .attr("fill","none")
       .attr("stroke","#999");
      }


    var node0 = gwellsnode2
      .selectAll("circle1")
      .data(newnode)
      .enter().append("circle")
      .attr("id", "graphnodesB")
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(d.depth==1)
            return d.rx*1.5;
        else if(d.depth==2)
            return Math.sqrt(d.rx)*5;
        else
            return Math.sqrt(d.rx)*1.5;

      })
      .attr("fill", function(d) { 
            return "#CDC9C9";
      })
      .attr("fill-opacity",function(d) { 
            return 1;
      })
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
  }
}
////////////////Random按钮////////////////////////////////
   btnrandom.onclick = function(){
     sankiorder.sort(function(){ return 0.5 - Math.random() });
     computer_sanki(sankiorder,sankistep);
     draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
   }
///////////////Uniform按钮//////////////////////////////////
   btn.onclick = function(){
    computer_sanki(sankiorder,sankistep);
    draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,1);
    console.log(start_x);
   }
//////////////////////btnuniform点击事件////////////////////
   btnuniform.onclick=function(){
    computer_sanki(sankiorder,sankistep);
    draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
   }
//////////////////////btncolormain点击事件////////////////////
   btncolormain.onclick=function(){
    draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
    for(var ii = 0 ;ii < attr.length;ii++){
        gwellsanki.selectAll(".rect"+ii)
        //.data(middleall[ii])
        .transition()
        .duration(100)
        .ease(d3.easeCubic)
        .attr("fill-opacity", 1)
        .attr("fill",function(d,i){
             //console.log(markcolor);
             var maincolor = 0;
             var mainvalue = 0;
             if(sankiorder[ii]!=9&&sankiorder[ii]!=0&&d.cnt2 > 3)
             for(var i = 0;i < randdata[sankiorder[ii]][d.cnt2%15].length;i++){
                if(randdata[sankiorder[ii]][d.cnt2%15][i] > mainvalue){
                      mainvalue = randdata[sankiorder[ii]][d.cnt2%15][i];
                      maincolor = i;
                }
             }
             else{
                maincolor = parseInt(Math.random()*(attrmax[sankiorder[ii]]+1));
             }
            if(sankiorder[ii] == 1||sankiorder[ii] == 2){
                return LightenDarkenColor(color(ii),100*maincolor);
            }
            else if(sankiorder[ii] == 4||sankiorder[ii] == 5||sankiorder[ii] == 7||sankiorder[ii] == 8)
                return LightenDarkenColor(color(ii),20*maincolor);
            else if(sankiorder[ii] == 6||sankiorder[ii] == 0)
                return LightenDarkenColor(color(ii),5*maincolor);
            else if(sankiorder[ii]==9)
                 return LightenDarkenColor(color(ii),20*maincolor);
            else
                return LightenDarkenColor(color(ii),20*maincolor);
        });
    }
   }
//////////////////////btntreemap点击事件////////////////////
   btntreemap.onclick=function(){
      for(var ii = 0 ;ii < attr.length;ii++){
        gwellsanki.selectAll(".rect"+ii)
        .transition()
        .duration(100)
        .ease(d3.easeCubic)
        .attr("fill-opacity", 0);


        for(var i = 0 ;i < sankimiddle[sankiorder[ii]].length;i++){
         if(sankimiddle[sankiorder[ii]][i].cnt2 > 15){
            var findflag = 0;
          hie.each(function(ddd){
            
            if(sankimiddle[sankiorder[ii]][i].cnt2 == ddd.leaves().length&&findflag == 0){
              findflag = 1;
              var maincolor = 0;
              var mainvalue = 0;
              if(sankiorder[ii]!=9&&sankiorder[ii]!=0)
              for(var j = 0;j < randdata[sankiorder[ii]][ddd.leaves().length%15].length;j++){
                 if(randdata[sankiorder[ii]][ddd.leaves().length%15][j] > mainvalue){
                      mainvalue = randdata[sankiorder[ii]][ddd.leaves().length%15][j];
                      maincolor = j;
                 }
              }
              var rootnow = ddd.copy();
              var treemap = d3.treemap()
                          .size([sankiwidth, sankimiddle[sankiorder[ii]][i].cnt2/4])
                          .padding(0.5);

              rootnow.each(function(dd){
                if(dd.height==0)
                  {
                    dd.value = 1;
                    dd.size = 1;
                  }
                else
                  dd.value = dd.leaves().length;
              });

              rootnow
                  //.sum(sumBySize)
                  .sort(function(a, b) { return b.height - a.height || b.value - a.value; });

                    treemap(rootnow);
                    //console.log(rootnow);

                     var cell = gwellsanki.selectAll("g"+sankiorder[ii]+i)
                        .data(rootnow.leaves())
                        .enter().append("g")
                        .attr("class","g"+sankiorder[ii]+i)
                        .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });
          
                        cell.append("rect")
                         //.attr("class","rect"+i)
                         .attr("id", function(d) { return d.data.id; })
                         .attr("width", function(d) { return d.x1 - d.x0; })
                         .attr("height", function(d) { return d.y1 - d.y0; })
                         .attr("x",function(d,iii){return 5 + sankistep*ii;})
                         .attr("y",function(d,iii){
                                //console.log(middleall[ii][i].x2 - middleall[ii][i].cnt2 / 16 +20);
                               return sankimiddle[sankiorder[ii]][i].x2 - sankimiddle[sankiorder[ii]][i].cnt2 / 16 +20;
                          })
                         .attr("fill", function(d,iii) {
                          if(sankiorder[ii] == 0)
                              return LightenDarkenColor(color(sankiorder[ii]),5*d.data.city);
                          else if(sankiorder[ii] == 1)
                              {
                                return LightenDarkenColor(color(sankiorder[ii]),100*d.data.vip);
                              }
                          else if(sankiorder[ii] == 2)
                              {
                                return LightenDarkenColor(color(sankiorder[ii]),100*d.data.sex);
                              }
                          else if(sankiorder[ii] == 3){
                            if(Math.random() > 0.6)
                              return LightenDarkenColor(color(sankiorder[ii]),20*maincolor);
                            return LightenDarkenColor(color(sankiorder[ii]),20*d.data.profession);
                          }
                          else if(sankiorder[ii] == 4){
                            if(Math.random() > 0.7)
                              LightenDarkenColor(color(sankiorder[ii]),20*maincolor)
                            return LightenDarkenColor(color(sankiorder[ii]),20*d.data.age);
                          }
                          else if(sankiorder[ii] == 5){
                            if(Math.random() > 0.7)
                              return LightenDarkenColor(color(sankiorder[ii]),20*maincolor);
                            return LightenDarkenColor(color(sankiorder[ii]),20*d.data.active);
                          }
                          else if(sankiorder[ii] == 6){
                            if(Math.random() > 0.8)
                              return LightenDarkenColor(color(sankiorder[ii]),20*maincolor);
                            return LightenDarkenColor(color(sankiorder[ii]),7*d.data.time);
                          }
                          else if(sankiorder[ii] == 7){
                            if(Math.random() > 0.8)
                              return LightenDarkenColor(color(sankiorder[ii]),20*maincolor);
                            return LightenDarkenColor(color(sankiorder[ii]),20*d.data.concern);
                          }
                          else if(sankiorder[ii] == 8){
                            if(Math.random() > 0.8)
                              return LightenDarkenColor(color(sankiorder[ii]),20*maincolor);
                            return LightenDarkenColor(color(sankiorder[ii]),20*d.data.beconcern);
                            }
                          else if(sankiorder[ii] == 9)
                                return LightenDarkenColor(color(sankiorder[ii]),15*d.data.area);
                        });


            }
          });

         }else{
          gwellsanki.append("rect")
          .attr("class","sankirect")
          .attr("x",5 + sankistep*ii)  
            .attr("y",sankimiddle[sankiorder[ii]][i].x2 - sankimiddle[sankiorder[ii]][i].cnt2 / 16 +20)  
            .attr("width", sankiwidth)  
            .attr("height",sankimiddle[sankiorder[ii]][i].cnt2/4)//每个矩形的高度  
            .attr("fill","steelblue");//填充颜色 

         }
      }
      }
   }
////////////////
btnden.onclick=function(){
	data_structure(sankimiddle,sankicomdata,sankiorder);
	console.log(middlenew);
	//draw_sort(middlenew,sankiorder);
	draw_sort(middlenew,sankialllines,sankiallwidth,sankiorder,sankistep,1);
	
}
////////////////构造排序数据//////////////////////////////
  function data_structure(middleall,comdata,order){
  	var rectdata = [];
  	var rectline = [];
  	var dataforsort = [];
  	for(var i = 0;i < attr.length;i++){
  		rectdata[i] = [];
  		dataforsort[i] = [];
  		for(var j = 0;j <= attrmax[i];j++){
  			rectdata[i][j] = [];
  			dataforsort[i] = [];
  		}
  	}
  	var maincolor,mainvalue;
  	for(var i = 0;i < attr.length;i++){
  	   for(var k = 0;k < middleall[i].length;k++){
  	   	   if(middleall[i][k].cnt2 > 3&&i!=0&&i!=9){
  	   	   maincolor = 0;
  	   	   mainvalue = 0;
  	       for(var j = 0;j < randdata[i][middleall[i][k].cnt2%15].length;j++){
                if(randdata[i][middleall[i][k].cnt2%15][j] > mainvalue){
                      mainvalue = randdata[i][middleall[i][j].cnt2%15][j];
                      maincolor = j;
                  }
               }
            }
            else{
            	maincolor =parseInt(Math.random()*(attrmax[i]+1));
            }
            //console.log("i "+i+" maincolor"+maincolor);
            rectdata[i][maincolor].push(middleall[i][k]);

          }
    }
    for(var i = 0;i < attr.length;i++){
    	for(var j = 0;j < rectdata[i].length;j++){
    		for(var k = 0;k < rectdata[i][j].length;k++){
    			rectdata[i][j][k].fill = j;
    			rectdata[i][j][k].sorti = k;
    			rectdata[i][j][k].gi = 0;
    		}
    	}
    }
    for(var i = 0;i < attr.length;i++){
    	for(var j = 0;j < rectdata[i].length;j++){
    		var xy1 = {"sorti":j ,"gi":0 , "data":rectdata[i][j]};
    		dataforsort[i][j]=xy1;
    	}
    }
    /*for(var i = 0;i < attr.length;i++){
    	rectdata[i].sort(function(){ return 0.5 - Math.random() })
    }*/
      console.log(rectdata);
      var rectdatafianl = [];
      /*for(var i = 0;i < attr.length;i++){
      	rectdatafianl[i]=[];
      	for(var j = 0;j < rectdata[i].length;j++){
      		//rectdata[i][j].sort(function(){ return 0.5 - Math.random() })
      		rectdatafianl[i] = rectdatafianl[i].concat(rectdata[i][j]);
      	}
      }
      console.log(dataforsort);
      console.log(rectdatafianl);*/
      //middlenew = rectdatafianl;
      for(var i = 0;i < attr.length-1;i++){
      	rectline[i] = [];
      	for(var j = 0;j < 40;j++){
      		rectline[i][j] = [];
      		for(var k = 0;k < 40;k++){
      			rectline[i][j][k] = 0;
      		}
      	}
      }
      for(var k = 0 ; k < attr.length - 1 ; k++){   
        var k1,k2;
        var nsource=0,ntarget=0;
        k1 = order[k] , k2=order[k+1];
        for(var i = 0;i < comdata[k1][k2].length;i++){
        	var findflag1 = false,findflag2=false;
        	for(var j = 0;j < rectdata[k1].length;j++){
        		for(var y = 0;y < rectdata[k1][j].length;y++){
        			if(middleall[k1][comdata[k1][k2][i].source].id==rectdata[k1][j][y].id)
        				{
        					//console.log("nsource"+j);
        					nsource = j; 
        					findflag1 = true;
        					break;
        				}
        		}
        		if(findflag1)break;
        	}
        	for(var j = 0;j < rectdata[k2].length;j++){
        		for(var y = 0;y < rectdata[k2][j].length;y++){
        			if(middleall[k2][comdata[k1][k2][i].target].id==rectdata[k2][j][y].id)
        				{
        					//console.log("k"+k);
        					ntarget = j; 
        					findflag2 = true;
        					break;
        				}
        		}
        		if(findflag2)break;
        	}
        	if(comdata[k1][k2][i].mark==1||comdata[k1][k2][i].mark==0){
        			rectline[k][nsource][ntarget] += middleall[k1][comdata[k1][k2][i].source].cnt2;
        	}
        	else{
        			rectline[k][nsource][ntarget] += middleall[k2][comdata[k1][k2][i].target].cnt2;
        	}


        }
    }

    console.log(rectline);
    for(var i = 0;i < rectline.length;i++)
    {
    	sortab(dataforsort[i],dataforsort[i+1],rectline[i]);
    }
    /*for(var i = 0;i < dataforsort.length;i++){
    	for(var j = 0;j < dataforsort[i].length;j++){
    		dataforsort[i][j].sorti = j;
    	}
    }
    for(var i = dataforsort.length;i > 0;i--)
    {
    	sortab(dataforsort[i],dataforsort[i-1],rectline[i]);
    }*/
    /*for(var i = 0;i < rectline.length;i++)
    {
    	var rectline2 = [];
    	for(var j = 0;j < dataforsort[i].length;j++){
    		rectline2[j] = [];
    		for(var k = 0;k < dataforsort[i+1].length;k++){
    			rectline2[j][k] = 0;
    		}
    	}
    	for(var j = 0;j < dataforsort[i].length;j++){
    		for(var k = 0;k < dataforsort[i+1].length;k++){
    			var k1 = order[k] , k2=order[k+1];
    			var findflag1 = false,findflag2=false;
    			for(var y = 0;y < comdata[k1][k2].length;y++){
        	        
        	        if(middleall[k1][comdata[k1][k2][y].source].id==dataforsort[i].data[j].id&&findflag1=false)
        				{
        					//console.log("nsource"+j);
        					nsource = j; 
        					findflag1 = true;
        				}
        		    if(middleall[k2][comdata[k1][k2][i].target].id==dataforsort[i+1].data[k].id&&findflag2=false)
        				{
        					//console.log("k"+k);
        					ntarget = j; 
        					findflag2 = true;
        				}
        		    if(findflag1&&findflag2)break;
        	    }
        	    if(findflag1&&findflag2){
        	    	if(comdata[k1][k2][y].mark==1||comdata[k1][k2][i].mark==0){
        			rectline[k][nsource][ntarget] += middleall[k1][comdata[k1][k2][i].source].cnt2;
        	    }
        	    else{
        			rectline[k][nsource][ntarget] += middleall[k2][comdata[k1][k2][i].target].cnt2;
        	      }
        	    }
    		}
    	}
    }

*/


    for(var i = 0;i < attr.length;i++){
      	rectdatafianl[i]=[];
      	for(var j = 0;j < rectdata[i].length;j++){
      		dataforsort[i][j].data.sort(function(){ return 0.5 - Math.random() })
      		rectdatafianl[i] = rectdatafianl[i].concat(dataforsort[i][j].data);
      	}
      }
    //middlenew = rectdatafianl;
    console.log(dataforsort);
    console.log(rectdatafianl);
    middlenew = rectdatafianl;

  }
////////////////两列排序的方法///////////////////////////
  function sortab(recta,rectb,abline){
  	for(var i = 0;i < rectb.length;i++){
  		var fenzi=0,fenmu=0;
  		for(var j = 0;j < recta.length;j++){
  			if(abline[j][i]!=0){
  			    fenzi += abline[j][i]*j;
  			    fenmu += abline[j][i];
  		    }
  		}
  		rectb[i].gi = fenzi/fenmu;
  		//console.log(fenzi/fenmu);
  	}
  	rectb.sort(compare("gi"));
  }
///////////////对象排序方法//////////////////////////////
function compare(property){
    return function(a,b){
        var value1 = a[property];
        var value2 = b[property];
        return value1 - value2;
    }
}
////////////////绘制图例的方法////////////////////////////
  function draw_legend(i){
    svggrapg.selectAll(".legend").remove();
    svggrapg.selectAll(".legendtext").remove();
    if(i==0){

    }
    else if(i==1||i==2){
      svggrapg.append("rect")
             .attr("fill",function(d){
                return LightenDarkenColor(color(i),150)
             })
             .attr("x",5)
             .attr("y",5)
             .attr("class","legend")
             .attr("id","graphr"+i)
             .attr("width",10 )
             .attr("height",10);
      svggrapg.append("rect")
             .attr("fill",function(d){
                return LightenDarkenColor(color(i),0)
             })
             .attr("x",5)
             .attr("y",25)
             .attr("class","legend")
             .attr("id","graphr"+i)
             .attr("width",10 )
             .attr("height",10);
        if(i==2){
            svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",30)
             .attr("y",13)
             .text("男");

           svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",30)
             .attr("y",33)
             .text("女");
        }
        else if(i==1){
            svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",30)
             .attr("y",13)
             .text("非Vip");

           svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",30)
             .attr("y",33)
             .text("Vip");
        }
    }
    else if(i==3)
    {
      for(var ii = 0;ii < 5;ii++){
         svggrapg.append("text")
             .attr("class","legendtext")
             //.attr("text-anchor","end")
             .attr("x",30)
             .attr("y",13+12*ii) 
             .attr("font",100)
             .text("Occ"+ii);
           
        svggrapg.append("rect")
             .attr("fill",function(d){
                return LightenDarkenColor(color(i),ii*25)
             })
             .attr("x",5)
             .attr("y",5+12*ii)
             .attr("class","legend")
             .attr("id","graphr"+i)
             .attr("width",10 )
             .attr("height",10);
           }
    }
    else if(i==10)
    {
    	for(var ii = 0;ii < attr.length;ii++){
         svggrapg.append("text")
             .attr("class","legendtext")
             //.attr("text-anchor","end")
             .attr("x",33+attr[ii].length*1.2)
             .attr("y",13+12*ii) 
             .attr("font",100)
             .text(attr[ii]);
           
        svggrapg.append("rect")
             .attr("fill",color(ii))
             .attr("x",0)
             .attr("y",5+12*ii)
             .attr("class","legend")
             .attr("id","graphr"+i)
             .attr("width",10 )
             .attr("height",10);
           }
    }
    else if(i==9)
    {
      for(var ii = 0;ii < 7;ii++){
         svggrapg.append("text")
             .attr("class","legendtext")
             //.attr("text-anchor","end")
             .attr("x",33)
             .attr("y",13+12*ii) 
             .attr("font",100)
             .text("Area"+ii);
           
        svggrapg.append("rect")
             .attr("fill",function(d){
                return LightenDarkenColor(color(i),ii*20)
             })
             .attr("x",5)
             .attr("y",5+12*ii)
             .attr("class","legend")
             .attr("id","graphr"+i)
             .attr("width",10 )
             .attr("height",10);
           }
    }
    else
    {
      var es = color(i);
      var ls = LightenDarkenColor(color(i),150);
      var linearGradient = svggrapg.append("defs").append("linearGradient")  
                        .attr("id","linearColor")  
                        .attr("x1","0%")  
                        .attr("y1","0%")  
                        .attr("x2","0%")  
                        .attr("y2","100%");  
  
      var stop1 = linearGradient.append("stop")  
                .attr("offset","0%")  
                .style("stop-color",ls.toString());  
  
      var stop2 = linearGradient.append("stop")  
                .attr("offset","100%")  
                .style("stop-color",es.toString());

      svggrapg.append("rect")  
            .attr("class","legend")
            .attr("x", 5)  
            .attr("y", 5)  
            .attr("width", 15)  
            .attr("height", 60)  
            .style("fill","url(#" + linearGradient.attr("id") + ")");   
      if(i==4){
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",32)
             .attr("y",13) 
             .text("少年");
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",32)
             .attr("y",63) 
             .text("老年");
      }
      else if(i==5){
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",45)
             .attr("y",13) 
             .text("活跃等级0");
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",45)
             .attr("y",63) 
             .text("活跃等级4");
      }
      else if(i==6){
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",32)
             .attr("y",13) 
             .text("0天");
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",32)
             .attr("y",63) 
             .text("15天");
      }
      else if(i==7){
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",60)
             .attr("y",13) 
             .text("评论数量级0");
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",60)
             .attr("y",63) 
             .text("评论数量级6");
      }
      else if(i==8){
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",60)
             .attr("y",13) 
             .text("粉丝数量级0");
        svggrapg.append("text")
             .attr("class","legendtext")
             .attr("text-anchor","end")
             .attr("x",60)
             .attr("y",63) 
             .text("粉丝数量级5");
      }
    }
  }





/////////////绘制排序后桑基图//////////////////////////////////
 function draw_sort(middleall,alllines,allwidth,order,sankistep,drawmark){
 ///////////////////////绘制方块/////////////////////////////
 svgsanki.selectAll(".sankirect").remove();
 for(var ii = 0 ;ii <= 9;ii++){
      for(var i = 0 ;i < middleall[ii].length;i++){
         svgsanki.selectAll(".g"+ii+i).remove();
       }
  }
   for(var ii = 0 ;ii < attr.length;ii++){
    svgsanki.selectAll(".rect"+order[ii]).remove();
    svgsanki.selectAll(".line"+ii).remove();
    svgsanki.selectAll(".label"+ii).remove();
   }
 if(drawmark==0){
  for(var ii = 0 ;ii < attr.length;ii++){
      gwellsanki.selectAll(".rect"+order[ii])
        .data(middleall[order[ii]])
        .enter()
        .append("rect")
        .attr("class","rect"+order[ii])
        .attr("id",function(d,i){
             return "attr" + order[ii] + "id" + d.id;
        })
        .attr("x",function(d,i){
             
             return 5 + sankistep*ii;
        })
        .attr("y",function(d,i){
             //yy = yy + d.cnt ;
             return d.x2 - d.cnt2 / 16 +20;
        })
        .attr("fill-opacity", 1)
        .attr("fill","steelblue")
        .attr("width",function(d){
         return sankiwidth;
        })
        .attr("height",function(d){
             return d.cnt2/4;
        }); 
      }
  }
  else if(drawmark==1){
  	var formerfill = 0;
    for(var ii = 0 ;ii < attr.length;ii++){
        var yy = 0,cntsum=0;
        var jiange = (800 - 1600/4)/(middleall[order[ii]].length-1);
        gwellsanki.selectAll(".rect"+order[ii])
        .data(middleall[order[ii]])
        .enter()
        .append("rect")
        .attr("class","rect"+order[ii])
        .attr("id",function(d,i){
             return "attr" + order[ii] + "id" + d.id;
        })
        .attr("x",function(d,i){
             return 5 + sankistep*ii;
        })
        .attr("y",function(d,i){
             if(i!=0)
             {
                  
                  cntsum += d.cnt;
                  //start_x[order[ii]].push(d.x);
                  if(d.fill==formerfill){
                  	  yy++;
                      d.x = cntsum/4 + yy*jiange + 20 -d.cnt/4
                      return cntsum/4 + yy*jiange + 20 -d.cnt/4;
                  }
                  else
                  {
                      yy+=10;
                      d.x = cntsum/4 + yy*jiange*10 + 20 -d.cnt/4
                      formerfill = d.fill;
                      return cntsum/4 + yy*jiange*10 + 20 -d.cnt/4;	
                  }
             }
             else
             {
                  //start_x[order[ii]].push(d.x);
                  formerfill = d.fill;
                  d.x = 20;
                  cntsum += d.cnt;
                  yy = 1;
                  return 20 ;
             }
        })
        .attr("fill-opacity", 1)
        .attr("fill", function(dd, i) {
                if(order[ii]==1||order[ii]==2)
                {
                  return LightenDarkenColor(color(order[ii]),100*dd.fill);
                }
                else if(order[ii] == 4||order[ii] == 5||order[ii] == 7||order[ii] == 8)
                  return LightenDarkenColor(color(order[ii]),20*dd.fill);
                else if(order[ii] == 4||order[ii] == 0)
                  return LightenDarkenColor(color(order[ii]),5*dd.fill);
                return LightenDarkenColor(color(order[ii]),20*dd.fill);
        })
        .attr("width",function(d){
         return sankiwidth;
        })
        .attr("height",function(d){
             return d.cnt/4;
        });
        
      }

  }
////////////////////////绘制标题和圆点/////////////////////////////
for(var i = 0;i < attr.length;i++){
    	gwellsanki.append("text")
           .attr("class","label"+i)
           .attr("text-anchor","end")
           .attr("y",12)
           .attr("x",5+sankiwidth/2 + sankistep*i)
           .text(attr[order[i]]);

    if(i!=attr.length-1)
        gwellsanki.append("circle")
         .attr("fill","#1E90FF")
         .attr("r",5)
         .attr("class","sankicicle")
         .attr("cx",sankistep/2+5+sankiwidth/2 + sankistep*i)
         .attr("cy",9)
         .datum(i); 
}
//////////////////注册点击事件/////////////////////////////
gwellsanki.selectAll(".sankicicle")
          .on("click",function(d){
            var temp = sankiorder[d];
            sankiorder[d] = sankiorder[d+1];
            sankiorder[d+1] = temp;
            console.log(sankiorder);
            computer_sanki(sankiorder,sankistep);
            draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
          });
 ////////////////////绘制连线//////////////////////////////
 if(drawmark==0)
 for(var k = 0 ; k < attr.length - 1 ; k++){
    gwellsanki.selectAll(".line"+k)
        .data(alllines[k])
        .enter()
        .append("path")
        .attr("class","line"+k)
        .attr("id",function(d,i){
          return "sankiline"+k+"of"+i;
        })
        .attr("d",function(d,i) {
          d.push(k);
          d.push(i);
          return lineFunction2(d[0]);
        })
        .attr("stroke","black")
        .attr("stroke-width",function(d,i) {
          return allwidth[k][i][0];
          // return 2;
         })
        .attr("fill","none")
        .attr("stroke-opacity",0.2)
        .on("click",function(d,i){
          console.log(d);
          d3.select("#sankiline"+d[2]+"of"+d[3])
            .attr("stroke","yellow")
            .attr("stroke-opacity",0.6);

            var nowwidth = allwidth[d[2]][i][0];
            var nowstart = d[0][1].y;
            var nowend = d[0][3].y;

            drawlineper(d[2],i,nowwidth,nowstart,nowend);
            drawlinenext(d[2],i,nowwidth,nowstart,nowend);

                  
        });
    }
  else if(drawmark==1){
    computer_sanki(sankiorder,132);
    for(var k = 0 ; k < attr.length - 1 ; k++){
    gwellsanki.selectAll(".line"+k)
        .data(alllines[k])
        .enter()
        .append("path")
        .attr("class","line"+k)
        .attr("id",function(d,i){
          return "sankiline"+k+"of"+i;
        })
        .attr("d",function(d,i) {
          d.push(k);
          d.push(i);
          return lineFunction2(d[1]);
        })
        .attr("stroke","black")
        .attr("stroke-width",function(d,i) {
          return allwidth[k][i][1];
          // return 2;
         })
        .attr("fill","none")
        .attr("stroke-opacity",0.2)
        .on("click",function(d,i){
          console.log(d);
          d3.select("#sankiline"+d[2]+"of"+d[3])
            .attr("stroke","yellow")
            .attr("stroke-opacity",0.6);

            var nowwidth = allwidth[d[2]][i][0];
            var nowstart = d[1][1].y;
            var nowend = d[1][3].y;

            drawlineper(d[2],i,nowwidth,nowstart,nowend);
            drawlinenext(d[2],i,nowwidth,nowstart,nowend);

                  
        });
    }
  }
}

//////////////计算画力引导图所用数据的函数//////////////////////
  function computer_graph(xx,yy,rr,d){
    if(d.height!=0){
      //console.log(x+" "+y+" "+r);
      d.groupnodes = [];
      d.grouplinks = [];
      for(var i = 0;i < d.children.length;i++){
        var anode={"id":i,"size":d.children[i].leaves().length,"rx":d.children[i].leaves().length,"ry":d.children[i].leaves().length};
        d.groupnodes.push(anode);
        for(var j = i+1;j < d.children.length;j++){
          var leave1 = d.children[i].leaves();
          var leave2 = d.children[j].leaves();
          var valuecnt = 0;
          var linkname = [];
          for(var k = 0;k < leave1.length;k++){
            linkname = linkname.concat(leave1[k].links);
          }
          dedupe(linkname);
          for(var k = 0;k < leave2.length;k++){
            if(indexOf(linkname,leave2[k].data.name) >= 0)
              valuecnt++;
          }
          if((valuecnt>0&&d.depth==0)||(d.depth!=0&&Math.random()>0.1))
          {
            if(d.depth!=0&&valuecnt==0)
              valuecnt=1;
            var alink={"source":i,"target":j,"value":valuecnt};
            d.grouplinks.push(alink);
          }
        }
      }
      if(d.depth==0)
      var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(dd) { return dd.id; }).distance(1))
        .force("collide", d3.forceCollide().radius(function(dd) { 
          if(d.depth==0)
              return dd.rx*1.5;
          else if(d.depth==1)
              return Math.sqrt(dd.rx)*5;
          else
              return Math.sqrt(dd.rx)*1.5;
        }))
        .force('charge', d3.forceManyBody().strength(-50).distanceMax(100))
        .force("center", d3.forceCenter(xx, yy ))
        .force("x", d3.forceX(xx).strength(0.1))
        .force("y", d3.forceY(yy).strength(0.1));
      else if(d.depth==1)
      var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(dd) { return dd.id; }).distance(1))
        .force("collide", d3.forceCollide().radius(function(dd) { 
          if(d.depth==0)
              return dd.rx*1.5;
          else if(d.depth==1)
              return Math.sqrt(dd.rx)*5;
          else
              return Math.sqrt(dd.rx)*1.5;
        }))
        .force('charge', d3.forceManyBody().strength(-20).distanceMax(50))
        .force("center", d3.forceCenter(xx, yy ))
        .force("x", d3.forceX(xx).strength(0.1))
        .force("y", d3.forceY(yy).strength(0.1));
      else
      var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(dd) { return dd.id; }).distance(1))
        .force("collide", d3.forceCollide().radius(0.3))
        .force('charge', d3.forceManyBody().strength(-15).distanceMax(5))
        .force("center", d3.forceCenter(xx , yy ))
        .force("x", d3.forceX(xx).strength(0.1))
        .force("y", d3.forceY(yy).strength(0.1));



      simulation.nodes(d.groupnodes);
      simulation.force("link").links(d.grouplinks);
      for (var i = 1000; i > 0; --i)simulation.tick();
    

    if(d.depth==0||d.depth==1){
      var bigr = rr;
      var maxd = 0;
      for(var ii = 0; ii < d.groupnodes.length;ii++){
        var rrd = Math.sqrt((d.groupnodes[ii].x - xx)*(d.groupnodes[ii].x - xx)+(d.groupnodes[ii].y -yy)*(d.groupnodes[ii].y - yy));
        if (rrd + d.groupnodes[ii].size*1.5 > maxd&&d.depth==0) 
          maxd = rrd + d.groupnodes[ii].size*1.5;
        if (rrd +Math.sqrt(d.groupnodes[ii].size)*5 > maxd&&d.depth==1) maxd = rrd + Math.sqrt(d.groupnodes[ii].size)*5;
      }
   for(var ii = 0; ii < d.groupnodes.length;ii++){
     if( maxd < bigr){

          var ddd=Math.sqrt((d.groupnodes[ii].x - xx)*(d.groupnodes[ii].x - xx)+(d.groupnodes[ii].y - yy)*(d.groupnodes[ii].y - yy));
          if(d.groupnodes[ii].x > xx)
              d.groupnodes[ii].x = xx + 0.92*bigr*(d.groupnodes[ii].x - xx)/maxd;
          else
              d.groupnodes[ii].x = xx - 0.92*bigr*(-d.groupnodes[ii].x + xx)/maxd;
          if(d.groupnodes[ii].y > yy)
              d.groupnodes[ii].y = yy + 0.92*bigr*(d.groupnodes[ii].y - yy)/maxd;
          else
              d.groupnodes[ii].y = yy - 0.92*bigr*(-d.groupnodes[ii].y + yy)/maxd;
          /*groupnodes[k][ii].y = (groupnodes[k][ii].y - centerarr[k+1].y)*(ddd)/(bigr-maxd);*/
      }
    }
  }




      for(var i = 0;i < d.children.length;i++){
        if(d.depth==0)
            computer_graph(d.groupnodes[i].x,d.groupnodes[i].y,d.groupnodes[i].rx*1.5,d.children[i]);
        else if(d.depth==1)
            computer_graph(d.groupnodes[i].x,d.groupnodes[i].y,Math.sqrt(d.groupnodes[i].rx)*5,d.children[i]);
        else
            computer_graph(d.groupnodes[i].x,d.groupnodes[i].y,Math.sqrt(d.groupnodes[i].rx)*1.5,d.children[i]);
      }


    }
  }
 ////////////////////绘制力引导图/////////////////////
  function draw_graph(dd,mark){
    if(dd.height!=0){
    if(dd.depth==0)
    {
       var link = gwellsline
      .selectAll("line1")
      .data(dd.grouplinks)
      .enter().append("line")
      .attr("id", "graphlinks"+dd.depth)
      .attr("class", "links1")
      .attr("stroke-width", function(d) { 
        if(dd.depth==0)
          return d.value*8;
        return d.value*2; 
      })
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; })
      .attr("stroke-opacity",0.6)
      .attr("stroke","#999");
    }
    else
    {
      var link = gwellsline3
      .selectAll("line1")
      .data(dd.grouplinks)
      .enter().append("line")
      .attr("id", "graphlinks"+dd.depth)
      .attr("class", "links1")
      .attr("stroke-width", function(d) { 
        if(dd.depth==0)
          return d.value*5;
        return d.value*2; 
      })
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; })
      .attr("stroke-opacity",0.6)
      .attr("stroke","#999");
    }
  



  if(mark == 1){
    if(dd.depth==0)
      var node1 = gwellsnode2
      .selectAll("circle1")
      .data(dd.groupnodes)
      .enter().append("circle")
      .attr("id", "graphnodes"+dd.depth)
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(dd.depth==0)
            return d.rx*1.5;
        else if(dd.depth==1)
            return Math.sqrt(d.rx)*5;
        else
            return Math.sqrt(d.rx)*1.5;

      })
      .attr("fill", function(d) { 
        if(dd.depth==0)
          return "#FFE4E1";
        return color(dd.height); 
      })
      .attr("fill-opacity",1)
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { 
        if(dd.depth==0){
          for(var ci = 0;ci < cutnow.length;ci++){
            var inflag = 0;
            for(var ii=0;ii < cutnow[ci].length;ii++){
              if(d.id == cutnow[ci][ii]){
                circler[ci].push(d.rx*1.5);
                circlecnt[ci].push(d.rx);
                circlex[ci].push(d.x);
                circley[ci].push(d.y);
                inflag = 1;
              }
            }
            if(!inflag){
              annulusr[ci].push(d.rx*1.5);
              annuluscnt[ci].push(d.rx);
              annulusx[ci].push(d.x);
              annulusy[ci].push(d.y);
            }
         }
        }
        else if(dd.depth==1){
          for(var ci = 0;ci < cutnowA.length;ci++){
          var inflag = false;
          for(var ii=0;ii < cutnowA[ci].length;ii++){
            if(d.id == cutnowA[ci][ii]){
               circler[ci].push(Math.sqrt(d.rx)*5);
               circlecnt[ci].push(d.rx);
               circlex[ci].push(d.x);
               circley[ci].push(d.y);
            }
          }
          if(!inflag){
            annulusr[ci].push(Math.sqrt(d.rx)*5);
            annuluscnt[ci].push(d.rx);
            annulusx[ci].push(d.x);
            annulusy[ci].push(d.y);
          }
         }
        }
        return d.y; 
      });

      else if(dd.depth==1)
      var node1 = gwellsnodesmall
      .selectAll("circle1")
      .data(dd.groupnodes)
      .enter().append("circle")
      .attr("id", "graphnodes"+dd.depth)
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(dd.depth==0)
            return d.rx*1.5;
        else if(dd.depth==1)
            return Math.sqrt(d.rx)*5;
        else
            return Math.sqrt(d.rx)*1.5;

      })
      .attr("fill", function(d) { 
        if(dd.depth==0)
          return "#FFE4E1";
        return color(dd.height); 
      })
      .attr("fill-opacity",1)
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { 
        if(dd.depth==0){
          for(var ci = 0;ci < cutnow.length;ci++){
            var inflag = 0;
            for(var ii=0;ii < cutnow[ci].length;ii++){
              if(d.id == cutnow[ci][ii]){
                circler[ci].push(d.rx*1.5);
                circlecnt[ci].push(d.rx);
                circlex[ci].push(d.x);
                circley[ci].push(d.y);
                inflag = 1;
              }
            }
            if(!inflag){
              annulusr[ci].push(d.rx*1.5);
              annuluscnt[ci].push(d.rx);
              annulusx[ci].push(d.x);
              annulusy[ci].push(d.y);
            }
         }
        }
        else if(dd.depth==1){
          for(var ci = 0;ci < cutnowA.length;ci++){
          var inflag = false;
          for(var ii=0;ii < cutnowA[ci].length;ii++){
            if(d.id == cutnowA[ci][ii]){
               circler[ci].push(Math.sqrt(d.rx)*5);
               circlecnt[ci].push(d.rx);
               circlex[ci].push(d.x);
               circley[ci].push(d.y);
            }
          }
          if(!inflag){
            annulusr[ci].push(Math.sqrt(d.rx)*5);
            annuluscnt[ci].push(d.rx);
            annulusx[ci].push(d.x);
            annulusy[ci].push(d.y);
          }
         }
        }
        return d.y; 
      });

      else if(dd.depth==2)
      var node1 = gwellsnodesmall
      .selectAll("circle1")
      .data(dd.groupnodes)
      .enter().append("circle")
      .attr("id", "graphnodes"+dd.depth)
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(dd.depth==0)
            return d.rx/5*2;
        else if(dd.depth==1)
            return Math.sqrt(d.rx)*2;
        else
            return 1.5;

      })
      .attr("fill", function(d) { 
        if(dd.depth==0)
          return "#FFE4E1";
        return color(dd.height); 
      })
      .attr("fill-opacity",1)
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { 
        if(dd.depth==0){
          for(var ci = 0;ci < cutnow.length;ci++){
            var inflag = 0;
            for(var ii=0;ii < cutnow[ci].length;ii++){
              if(d.id == cutnow[ci][ii]){
                circler[ci].push(d.rx*1.5);
                circlecnt[ci].push(d.rx);
                circlex[ci].push(d.x);
                circley[ci].push(d.y);
                inflag = 1;
              }
            }
            if(!inflag){
              annulusr[ci].push(d.rx*1.5);
              annuluscnt[ci].push(d.rx);
              annulusx[ci].push(d.x);
              annulusy[ci].push(d.y);
            }
         }
        }
        else if(dd.depth==1){
          for(var ci = 0;ci < cutnowA.length;ci++){
          var inflag = false;
          for(var ii=0;ii < cutnowA[ci].length;ii++){
            if(d.id == cutnowA[ci][ii]){
               circler[ci].push(Math.sqrt(d.rx)*5);
               circlecnt[ci].push(d.rx);
               circlex[ci].push(d.x);
               circley[ci].push(d.y);
            }
          }
          if(!inflag){
            annulusr[ci].push(Math.sqrt(d.rx)*5);
            annuluscnt[ci].push(d.rx);
            annulusx[ci].push(d.x);
            annulusy[ci].push(d.y);
          }
         }
        }
        return d.y; 
      });
}

      for(var i = 0;i < dd.children.length;i++){
        draw_graph(dd.children[i],1);
      }
    }

  }


  //////////////改变力引导图绘制方式//////////////////////
var switchflag = true;

function Switch(){
  gwellsnodesmall.selectAll(".piepath").remove();
  gwellsnodebig.selectAll(".piepath").remove();
  gwellsline.selectAll(".links1").remove();
  gwellsline2.selectAll(".Bundling").remove();
  gwellsline3.selectAll(".links1").remove();
  svggrapg.selectAll("#graphnodesB").remove();
  svggrapg.selectAll("#graphnodes0").remove();
  svggrapg.selectAll("#graphnodes1").remove();
  svggrapg.selectAll("#graphnodes2").remove();
  //gwellsline3.select("#grouplinks2").remove();
  if(switchflag){
  var newnode=[];
  var newlink=[];
  hie.each(function(d1){
    for(var i = 0;i < finalcut[nowclick].length;i++){
      if(d1.id == finalcut[nowclick][i]){

        var anode={"id":d1.id,"size":d1.leaves().length,"rx":d1.leaves().length,"ry":d1.leaves().length,"x":d1.gx,"y":d1.gy,"depth":d1.depth};
        newnode.push(anode);
      }
    }
  });
  
  var leaf1 = [];
  var leaf2 = [];
  var cntid = 0;
  for(var i = 0;i < newnode.length;i++){
    for(var j = i+1;j < newnode.length;j++){
       hie.each(function(d1){
         if(d1.id==newnode[i].id)
           leaf1 = d1.leaves();
         if(d1.id==newnode[j].id)
           leaf2 = d1.leaves();
         });
       var linkname = [];
       var valuecnt = 0;
       for(var k = 0;k < leaf1.length;k++){
            linkname = linkname.concat(leaf1[k].links);
          }
          dedupe(linkname);
       for(var k = 0;k < leaf2.length;k++){
            if(indexOf(linkname,leaf2[k].data.name) >= 0)
              valuecnt++;
          }
          if(valuecnt>0)
          {
            var alink={"id":cntid,"source":i,"target":j,"value":valuecnt};
            cntid++;
            newlink.push(alink);
          }
      }
    }
    for(var i = 0;i < newnode.length;i++){
    	newnode[i].id = i;
    }
    console.log(newnode);
    console.log(newlink);
    var fbundling = d3.ForceEdgeBundling().nodes(newnode).edges(newlink);
    var resultsccc = fbundling();
    console.log(resultsccc);
    for(var i = 0; i < resultsccc.length; i++){
       var linkccc = gwellsline2
       .append("path")
       .attr("d", lineFunction2(resultsccc[i]))
       .attr("class","Bundling")
       .attr("stroke-width", function(d) { 
        return Math.sqrt(resultsccc[i][0].size)*2;
      })
       .attr("stroke-opacity",0.2)
       .attr("fill","none")
       .attr("stroke","#999");
      }


    var node0 = gwellsnode2
      .selectAll("circle1")
      .data(newnode)
      .enter().append("circle")
      .attr("id", "graphnodesB")
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(d.depth==1)
            return d.rx*1.5;
        else if(d.depth==2)
            return Math.sqrt(d.rx)*5;
        else
            return Math.sqrt(d.rx)*1.5;

      })
      .attr("fill", function(d) { 
            return "white";
      })
      .attr("fill-opacity",function(d) { 
            return 1;
      })
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });

    var node1 = gwellsnode2
      .selectAll("circle1")
      .data(newnode)
      .enter().append("circle")
      .attr("id", "graphnodesB")
      //.attr("class", "nodes2")
      .attr("r", function(d) { 
        if(d.depth==1)
            return d.rx*1.5;
        else if(d.depth==2)
            return Math.sqrt(d.rx)*5;
        else
            return Math.sqrt(d.rx)*1.5;

      })
      .attr("fill", function(d) { 
      	/*if(nowclick==10){
          var nowcolor = color(Math.random()*10);
      		return LightenDarkenColor(nowcolor,parseInt(Math.random()*100));
        }*/
        var maincolor = 0;
        var mainvalue = 0;
        if(nowclick!=9&&nowclick!=0&&d.rx>1)
          for(var i = 0;i < randdata[nowclick][d.rx%15].length;i++){
                if(randdata[nowclick][d.rx%15][i] > mainvalue){
                      mainvalue = randdata[nowclick][d.rx%15][i];
                      maincolor = i;
                }
          }
        else{
          maincolor = parseInt(Math.random()*(attrmax[nowclick]+1));
        }
        if(nowclick==1||nowclick==2)
        {
            return LightenDarkenColor(color(nowclick),100*maincolor);
        }
        else if(nowclick == 4||nowclick == 5||nowclick == 7||nowclick == 8)
        {
            return LightenDarkenColor(color(nowclick),30*maincolor);
        }
        else if(nowclick == 0||nowclick==6)
            return LightenDarkenColor(color(nowclick),5*maincolor);
        else if(nowclick==10)
            return color(maincolor);
        else
            return LightenDarkenColor(color(nowclick),30*maincolor);
      })
      .attr("fill-opacity",function(d) { 
        if(nowclick==10)
      	    return 0.3+(Math.random()*0.7);
        else
          return 1;
      })
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });

          }
   else{
        draw_graph(hie,2);
    }
   
   //switchflag = !switchflag;
}
//////////////////轴交换点击事件////////////////////////
/*svgsanki.selectAll(".sankicicle")
          .on("click",function(d){
            var temp = sankiorder[d];
            sankiorder[d] = sankiorder[d+1];
            sankiorder[d+1] = temp;
            console.log(sankiorder);
            computer_sanki(sankiorder,sankistep);
            draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
          });*/
//////////////////////桑基图数据处理/////////////////////
function computer_sanki(order,sankistep){
////////////////////////准备方块位置数据////////////////////
  var middle1 = middle.concat();
  var middleall = [];
  for(var i = 0 ;i < attr.length;i++){
    middleall[i] = [[0],[0]];
    //middleall[i].pos1 =[];
    //middleall[i].pos2 =[];
  }
  for(var ii = 0 ;ii < attr.length;ii++){
  middle1[ii] = middle[ii].concat();
  middle1[ii].sort(function(a,b){return b.cnt-a.cnt;});
  for(var aa = 0;aa < middle1[ii].length;aa++){
    for(var bb = 0;bb < middle[ii].length;bb++){
      if(middle1[ii][aa].id == middle[ii][bb].id)
        middle1[ii][aa].num = bb;
    }
  }
  if(ii!=attr.length-1)
  for(var aa = 0;aa < middle1[ii+1].length;aa++){
    for(var bb = 0;bb < middle[ii+1].length;bb++){
      if(middle1[ii+1][aa].id == middle[ii+1][bb].id)
        middle1[ii+1][aa].num = bb;
    }
  }

  middleall[ii] = middle1[ii].concat();
  for(var j = 0 ; j < middleall[ii].length;j++){
    middleall[ii][j].cnt2 = middle[ii][j].cnt;
    middleall[ii][j].x2 = middle[ii][j].x;
    middleall[ii][j].id2 = middle[ii][j].id;
    middleall[ii][j].num2 = middle[ii][j].num;
    middleall[ii][j].y2 = middle[ii][j].y;
  }
}

	////////////////////////准备连线匹配数据////////////////////
    for(var i = 0; i < attr.length - 1;i++){
        alllines[i]= [];
        allwidth[i]= [];
    }
    for(var i = 0; i < attr.length - 1;i++){
        for(var j = 0; j < 2500 ;j++){
            alllines[i][j]= [[],[]];
            allwidth[i][j]= [[],[]];
        }
    }
	  var comdata = [];
    cutcnt =[];
    for(var i = 0 ; i < 10 ; i++)
      {
        comdata[i] = [];
        cutcnt[i] = [];
      }
    for(var i = 0 ; i < 10 ; i++)
      for(var j = 0 ; j < 10 ;j++)
      {
        comdata[i][j] = [];
        cutcnt[i][j] = 0;
      }
    for(var i = 0 ;i < attr.length - 1; i++){
      for(var j = i + 1 ;j < attr.length ; j++){
    var zhia = 0,zhib = 0;
    while(zhia < finalcut[i].length - 1 && zhib < finalcut[j].length - 1){
      var line1={"source":0,"target":0,"mark":0};
      if(zhia >= finalcut[i].length) zhia = finalcut[i].length - 1;
      if(zhib >= finalcut[j].length) zhib = finalcut[j].length -1;
      if(finalcut[i][zhia] == finalcut[j][zhib]){
        flaga = true;
        flagb = true;
        line1.source = zhia;
        line1.target = zhib;
        line1.mark = 0;
        comdata[i][j].push(line1);
        //console.log(line1);
        zhia++;
        zhib++;
        continue;
      }
      traverseTreeFind2(hie ,i ,j,zhia ,zhib);
      //console.log(flag11 + flag22);
      if(flag11){
        flag11 = false,flag22 = false;
        line1.source = zhia;
        line1.target = zhib;
        line1.mark = 1;
        comdata[i][j].push(line1);
        flaga = true;
        flagb = false;
        //console.log(line1);
        zhia++;
        //console.log('zhia'+zhia);
        continue;
      }
      if(flag22){
        flag11 = false,flag22 = false;
        line1.source = zhia;
        line1.target = zhib;
        line1.mark = 2;
        comdata[i][j].push(line1);
        //console.log(line1);
        zhib++;
        flaga = false;
        flagb = true;
        //console.log('zhib'+zhib);
        continue;
      }
      
      if(!flag22||!flag11){
        if(flaga) zhib++;
        else if(flagb) zhia++;
      }
    }
  }
}
    console.log(comdata);
    var nodec1,nodec2; 
    for(var i = 0 ; i < 9 ; i++)
      for(var j = i+1 ; j < 10 ;j++)
      {
        nodec1 = null;
          nodec2 = null;
        compare_cut(comdata[i][j],i,j);
        hie.each(function(d){
                d.visit = false;
              });
      }
    for(var i = 0 ; i < 10 ; i++)
      for(var j = 0 ; j < 10 ;j++)
      {
        if(i != j && cutcnt[i][j] == 0) 
          cutcnt[i][j] = cutcnt[j][i];
      }
    //console.log(cutcnt);
    
    for(var i = 0 ;i < comdata.length;i++){
      for(var j = 0 ;j < comdata[i].length;j++){
        if(i > j) {
          comdata[i][j] = comdata[j][i].concat();
          
          for(var k = 0; k < comdata[i][j].length;k++){
          var temp = 1 + comdata[i][j][k].source - 1;
          //comdata[i][j][k].source = comdata[i][j][k].target +1 -1;
          //comdata[i][j][k].target = temp;
        }
        }
    }
  }
  
    ///////////排列方式1的连线数据//////////////////////
  for(var k = 0 ; k < attr.length - 1 ; k++){   
    var formersource = -1, formertarget = -1;
    var xcnt = 0;
    var k1,k2;
    k1 = order[k] , k2=order[k+1];
    for(var i = 0;i < comdata[k1][k2].length;i++){
           var aline = new Array();
           var swidth = 0;
           var xy1 = {"x":0 , "y":0};
           var xy2 = {"x":0 , "y":0};
           var xy3 = {"x":0 , "y":0};
           var xy4 = {"x":0 , "y":0};
           //console.log("k1 "+k1+" "+"k2 "+k2+" "+i)
           if(comdata[k1][k2][i].mark == 0)
           {
            if(k2>k1){
               swidth = middleall[k1][comdata[k1][k2][i].source].cnt2 / 4;
               xcnt = 0;
               xy1.y = middleall[k1][comdata[k1][k2][i].source].x2  + swidth/4 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].source].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].target].x2 + swidth/4 +20; 
               xy2.x = middleall[k2][comdata[k1][k2][i].target].y2 + 5+sankistep +sankistep*k;
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 3*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
             }else{
               swidth = middleall[k1][comdata[k1][k2][i].target].cnt2 / 4;
               xcnt = 0;
               xy1.y = middleall[k1][comdata[k1][k2][i].target].x2  + swidth/4 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].target].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].source].x2  + swidth/4 +20;
               xy2.x = middleall[k2][comdata[k1][k2][i].source].y2 + 5+sankistep +sankistep*k;
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 3*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
             }
           }
           if(comdata[k1][k2][i].mark == 1)//汇聚
           {
            if(k2>k1){
              //console.log("k1"+k1+" "+"k2"+k2+" "+"i"+i);
               swidth = middleall[k1][comdata[k1][k2][i].source].cnt2 / 4;
               if(formertarget != comdata[k1][k2][i].target) xcnt = 0;
               var cal = middleall[k1][comdata[k1][k2][i].source].cnt2 / middleall[k2][comdata[k1][k2][i].target].cnt2;
               xy1.y = middleall[k1][comdata[k1][k2][i].source].x2 + swidth/4 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].source].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].target].x2 - middleall[k2][comdata[k1][k2][i].target].cnt2/16 + xcnt*middleall[k2][comdata[k1][k2][i].target].cnt2/4 + swidth/2 +20;
               xy2.x = middleall[k2][comdata[k1][k2][i].target].y2 + 5+sankistep +sankistep*k ;
               xcnt += cal;

               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
            }else{
               swidth = middleall[k2][comdata[k1][k2][i].source].cnt2 / 4;
               if(formertarget != comdata[k1][k2][i].target) xcnt = 0;
               var cal = middleall[k2][comdata[k1][k2][i].source].cnt2 / middleall[k1][comdata[k1][k2][i].target].cnt2;
               xy1.y = middleall[k1][comdata[k1][k2][i].target].x2  - middleall[k1][comdata[k1][k2][i].target].cnt2/16 + xcnt*middleall[k1][comdata[k1][k2][i].target].cnt2/4 +swidth/2 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].target].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].source].x2 + swidth/4 +20;
               xy2.x = middleall[k2][comdata[k1][k2][i].source].y2 + 5+sankistep +sankistep*k ;
               xcnt += cal;
               
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
            }
           }
           if(comdata[k1][k2][i].mark == 2)//发散
           {
            if(k2>k1){
               swidth = middleall[k2][comdata[k1][k2][i].target].cnt2 / 4;
               if(formersource != comdata[k1][k2][i].source) xcnt = 0;
               var cal = middleall[k2][comdata[k1][k2][i].target].cnt2 / middleall[k1][comdata[k1][k2][i].source].cnt2;
               xy1.y = middleall[k1][comdata[k1][k2][i].source].x2  - middleall[k1][comdata[k1][k2][i].source].cnt2/16 + xcnt*middleall[k1][comdata[k1][k2][i].source].cnt2/4 +swidth/2 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].source].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].target].x2 + swidth/4 +20;
               xy2.x = middleall[k2][comdata[k1][k2][i].target].y2 + 5+sankistep +sankistep*k ;
               xcnt += cal;
               
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
           }else{

               swidth = middleall[k1][comdata[k1][k2][i].target].cnt2 / 4;
               if(formersource != comdata[k1][k2][i].source) xcnt = 0;
               var cal = middleall[k1][comdata[k1][k2][i].target].cnt2 / middleall[k2][comdata[k1][k2][i].source].cnt2;
               xy1.y = middleall[k1][comdata[k1][k2][i].target].x2 + swidth/4 +20;
               xy1.x = middleall[k1][comdata[k1][k2][i].target].y2 + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][comdata[k1][k2][i].source].x2 - middleall[k2][comdata[k1][k2][i].source].cnt2/16 + xcnt*middleall[k2][comdata[k1][k2][i].source].cnt2/4 + swidth/2 +20;
               xy2.x = middleall[k2][comdata[k1][k2][i].source].y2 + 5+sankistep +sankistep*k ;
               xcnt += cal;

               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
           }
         }
         
           formersource = comdata[k1][k2][i].source;
           formertarget = comdata[k1][k2][i].target;
           alllines[k][i][0] = aline;
           allwidth[k][i][0] = swidth;
    }
 
} 
///////////排列方式2的连线数据//////////////////////

for(var k = 0 ; k < attr.length - 1 ; k++){   
  var formersource = -1, formertarget = -1;
  var xcnt = 0;
  var k1,k2;
  k1 = order[k] , k2=order[k+1];
    for(var i = 0;i < comdata[k1][k2].length;i++){
           var aline = new Array();
           var swidth = 0;
           var xy1 = {"x":0 , "y":0};
           var xy2 = {"x":0 , "y":0};
           var xy3 = {"x":0 , "y":0};
           var xy4 = {"x":0 , "y":0};
           
           var linenuma = 0,linenumb = 0;
           if(k2>k1){
           for(var aa = 0;aa < middleall[k1].length;aa++){
            if(middleall[k1][aa].num == comdata[k1][k2][i].source){
                  linenuma = aa;
              //console.log("linenuma"+linenuma);
                  break;
            }
           }
           for(var bb = 0;bb < middleall[k2].length;bb++){
            if(middleall[k2][bb].num == comdata[k1][k2][i].target){
                  linenumb = bb;
                  break;
            }
           }
         }else{
          for(var aa = 0;aa < middleall[k1].length;aa++){
            if(middleall[k1][aa].num == comdata[k1][k2][i].target){
                  linenuma = aa;
              //console.log("linenuma"+linenuma);
                  break;
            }
           }
           for(var bb = 0;bb < middleall[k2].length;bb++){
            if(middleall[k2][bb].num == comdata[k1][k2][i].source){
                  linenumb = bb;
                  break;
            }
           }
         }

           //console.log("k1 "+k1+" "+"k2 "+k2+" "+"a "+linenuma+" b "+linenumb);
           if(comdata[k1][k2][i].mark == 0)
           {
            //if(k2>k1){
               swidth = middleall[k1][linenuma].cnt / 4;
               xcnt = 0;
               xy1.y = middleall[k1][linenuma].x  + swidth/2;
               xy1.x = middleall[k1][linenuma].y + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][linenumb].x + swidth/2;
               xy2.x = middleall[k2][linenumb].y + 5+sankistep + sankistep*k;
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 3*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
             
           }
           if(comdata[k1][k2][i].mark == 1)//汇聚
           {
            if(k2>k1){
              //console.log("k1"+k1+" "+"k2"+k2+" "+"i"+i);
               swidth = middleall[k1][linenuma].cnt / 4;
               if(formertarget != linenumb) xcnt = 0;
               var cal = middleall[k1][linenuma].cnt/ middleall[k2][linenumb].cnt;
               xy1.y = middleall[k1][linenuma].x  + swidth/2;
               xy1.x = middleall[k1][linenuma].y + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][linenumb].x  + xcnt*middleall[k2][linenumb].cnt/4 + swidth/2 ;
               xy2.x = middleall[k2][linenumb].y + 5+sankistep +sankistep*k ;
               xcnt += cal;

               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
            }else{
               swidth = middleall[k2][linenumb].cnt / 4;
               if(formersource != linenuma) xcnt = 0;
               var cal = middleall[k2][linenumb].cnt / middleall[k1][linenuma].cnt;
               xy1.y = middleall[k1][linenuma].x + xcnt*middleall[k1][linenuma].cnt/4 +swidth/2;
               xy1.x = middleall[k1][linenuma].y + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][linenumb].x + swidth/2;
               xy2.x = middleall[k2][linenumb].y + 5+sankistep +sankistep*k ;
               xcnt += cal;
               
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
            }
           }
           if(comdata[k1][k2][i].mark == 2)//发散
           {
            if(k2>k1){
               swidth = middleall[k2][linenumb].cnt / 4;
               if(formersource != linenuma) xcnt = 0;
               var cal = middleall[k2][linenumb].cnt / middleall[k1][linenuma].cnt;
               xy1.y = middleall[k1][linenuma].x  + xcnt*middleall[k1][linenuma].cnt/4 +swidth/2;
               xy1.x = middleall[k1][linenuma].y + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][linenumb].x + swidth/2;
               xy2.x = middleall[k2][linenumb].y + 5+sankistep +sankistep*k ;
               xcnt += cal;
               
               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
           }else{

               swidth = middleall[k1][linenuma].cnt / 4;
               if(formertarget != linenumb) xcnt = 0;
               var cal = middleall[k1][linenuma].cnt/ middleall[k2][linenumb].cnt;
               xy1.y = middleall[k1][linenuma].x  + swidth/2;
               xy1.x = middleall[k1][linenuma].y + 5+sankiwidth + sankistep*k;
               aline.push(xy1);
               xy2.y = middleall[k2][linenumb].x  + xcnt*middleall[k2][linenumb].cnt/4 + swidth/2 ;
               xy2.x = middleall[k2][linenumb].y + 5+sankistep +sankistep*k ;
               xcnt += cal;

               xy3.x = xy1.x + (xy2.x - xy1.x)/5;
               xy3.y = xy1.y ;
               xy4.x = xy1.x + 4*(xy2.x - xy1.x)/5;
               xy4.y = xy2.y ;
               aline.push(xy3);
               aline.push(xy4);
               aline.push(xy2);
           }
         }
         
           formersource = linenuma;
           formertarget = linenumb;
           alllines[k][i][1] = aline;
           allwidth[k][i][1] = swidth;
    }
 
} 
    console.log(alllines);
    console.log(allwidth);
    sankimiddle = middleall;
    sankiallwidth = allwidth;
    sankialllines = alllines;
    if(firstflag){
      sankialllinesseed = alllines.concat();
      sankimiddleseed = middleall.concat();
      sankiallwidthseed = allwidth.concat();
      sankicomdata = comdata.concat();
      firstflag = false;
    } 
}
///////////////////////////////绘制桑基图的方法/////////////////////////
function draw_sanki(middleall,alllines,allwidth,order,sankistep,drawmark){
 ///////////////////////绘制方块/////////////////////////////
 svgsanki.selectAll(".sankirect").remove();
 for(var ii = 0 ;ii <= 9;ii++){
      for(var i = 0 ;i < middleall[ii].length;i++){
         svgsanki.selectAll(".g"+ii+i).remove();
       }
  }
   for(var ii = 0 ;ii < attr.length;ii++){
    svgsanki.selectAll(".rect"+order[ii]).remove();
    svgsanki.selectAll(".line"+ii).remove();
    svgsanki.selectAll(".label"+ii).remove();
   }
 if(drawmark==0){
  for(var ii = 0 ;ii < attr.length;ii++){
      gwellsanki.selectAll(".rect"+order[ii])
        .data(middleall[order[ii]])
        .enter()
        .append("rect")
        .attr("class","rect"+order[ii])
        .attr("id",function(d,i){
             return "attr" + order[ii] + "id" + d.id;
        })
        .attr("x",function(d,i){
             
             return 5 + sankistep*ii;
        })
        .attr("y",function(d,i){
             //yy = yy + d.cnt ;
             return d.x2 - d.cnt2 / 16 +20;
        })
        .attr("fill-opacity", 1)
        .attr("fill","steelblue")
        .attr("width",function(d){
         return sankiwidth;
        })
        .attr("height",function(d){
             return d.cnt2/4;
        }); 
      }
  }
  else if(drawmark==1){
    for(var ii = 0 ;ii < attr.length;ii++){
        var yy = 0,cntsum=0;
        var jiange = (800 - 1618/4)/(middleall[order[ii]].length-1);
        gwellsanki.selectAll(".rect"+order[ii])
        .data(middleall[order[ii]])
        .enter()
        .append("rect")
        .attr("class","rect"+order[ii])
        .attr("id",function(d,i){
             return "attr" + order[ii] + "id" + d.id;
        })
        .attr("x",function(d,i){
             return 5 + sankistep*ii;
        })
        .attr("y",function(d,i){
             if(i!=0)
             {
                  yy++;
                  cntsum += d.cnt;
                  start_x[order[ii]].push(d.x);
                  d.x = cntsum/4 + yy*jiange + 20 -d.cnt/4
                  return cntsum/4 + yy*jiange + 20 -d.cnt/4;
             }
             else
             {
                  start_x[order[ii]].push(d.x);
                  d.x = 20;
                  cntsum += d.cnt;
                  yy = 1;
                  return 20 ;
             }
        })
        .attr("fill-opacity", 1)
        .attr("fill","steelblue")
        .attr("width",function(d){
         return sankiwidth;
        })
        .attr("height",function(d){
             return d.cnt/4;
        });
        
      }

  }
////////////////////////绘制标题和圆点/////////////////////////////
for(var i = 0;i < attr.length;i++){
    	gwellsanki.append("text")
           .attr("class","label"+i)
           .attr("text-anchor","end")
           .attr("y",12)
           .attr("x",5+sankiwidth/2 + sankistep*i)
           .text(attr[order[i]]);

    if(i!=attr.length-1)
        gwellsanki.append("circle")
         .attr("fill","#1E90FF")
         .attr("r",5)
         .attr("class","sankicicle")
         .attr("cx",sankistep/2+5+sankiwidth/2 + sankistep*i)
         .attr("cy",9)
         .datum(i); 
}
//////////////////注册点击事件/////////////////////////////
gwellsanki.selectAll(".sankicicle")
          .on("click",function(d){
            var temp = sankiorder[d];
            sankiorder[d] = sankiorder[d+1];
            sankiorder[d+1] = temp;
            console.log(sankiorder);
            computer_sanki(sankiorder,sankistep);
            draw_sanki(sankimiddle,sankialllines,sankiallwidth,sankiorder,sankistep,0);
          });
 ////////////////////绘制连线//////////////////////////////
 if(drawmark==0)
 for(var k = 0 ; k < attr.length - 1 ; k++){
    gwellsanki.selectAll(".line"+k)
        .data(alllines[k])
        .enter()
        .append("path")
        .attr("class","line"+k)
        .attr("id",function(d,i){
          return "sankiline"+k+"of"+i;
        })
        .attr("d",function(d,i) {
          d.push(k);
          d.push(i);
          return lineFunction2(d[0]);
        })
        .attr("stroke","black")
        .attr("stroke-width",function(d,i) {
          return allwidth[k][i][0];
          // return 2;
         })
        .attr("fill","none")
        .attr("stroke-opacity",0.2)
        .on("click",function(d,i){
          console.log(d);
          d3.select("#sankiline"+d[2]+"of"+d[3])
            .attr("stroke","yellow")
            .attr("stroke-opacity",0.6);

            var nowwidth = allwidth[d[2]][i][0];
            var nowstart = d[0][1].y;
            var nowend = d[0][3].y;

            drawlineper(d[2],i,nowwidth,nowstart,nowend);
            drawlinenext(d[2],i,nowwidth,nowstart,nowend);

                  
        });
    }
  else if(drawmark==1){
    computer_sanki(sankiorder,132);
    for(var k = 0 ; k < attr.length - 1 ; k++){
    gwellsanki.selectAll(".line"+k)
        .data(alllines[k])
        .enter()
        .append("path")
        .attr("class","line"+k)
        .attr("id",function(d,i){
          return "sankiline"+k+"of"+i;
        })
        .attr("d",function(d,i) {
          d.push(k);
          d.push(i);
          return lineFunction2(d[1]);
        })
        .attr("stroke","black")
        .attr("stroke-width",function(d,i) {
          return allwidth[k][i][1];
          // return 2;
         })
        .attr("fill","none")
        .attr("stroke-opacity",0.2)
        .on("click",function(d,i){
          console.log(d);
          d3.select("#sankiline"+d[2]+"of"+d[3])
            .attr("stroke","yellow")
            .attr("stroke-opacity",0.6);

            var nowwidth = allwidth[d[2]][i][0];
            var nowstart = d[1][1].y;
            var nowend = d[1][3].y;

            drawlineper(d[2],i,nowwidth,nowstart,nowend);
            drawlinenext(d[2],i,nowwidth,nowstart,nowend);

                  
        });
    }
  }
}


function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node1
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
}

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}


function LightenDarkenColor(col, amt) {
 var usePound = false; 
 if (col[0] == "#") {
   col = col.slice(1);
   usePound = true;
 } 
 var num = parseInt(col,16);
 var r = (num >> 16) + amt;
 if (r > 255) r = 255;
 else if (r < 0) r = 0;
 var b = ((num >> 8) & 0x00FF) + amt;
 if (b > 255) b = 255;
 else if (b < 0) b = 0;
 var g = (num & 0x0000FF) + amt;
 if (g > 255) g = 255;
 else if (g < 0) g = 0;
 return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
}
String.prototype.colorRgb = function(){  
    var sColor = this.toLowerCase();  
    if(sColor && reg.test(sColor)){  
        if(sColor.length === 4){  
            var sColorNew = "#";  
            for(var i=1; i<4; i+=1){  
                sColorNew += sColor.slice(i,i+1).concat(sColor.slice(i,i+1));     
            }  
            sColor = sColorNew;  
        }  
        //处理六位的颜色值  
        var sColorChange = [];  
        for(var i=1; i<7; i+=2){  
            sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));    
        }  
        return "RGB(" + sColorChange.join(",") + ")";  
    }else{  
        return sColor;    
    }  
};  
 
function dedupe(array){ return Array.from(new Set(array));}

  //console.log(hie);
  //console.log(hie.leaves().length);

    function drawlineper(k,i,lwidth,starty,endy){
      if(k==0)
        return;
      for(var ii = 0;ii < 2500;ii++){
      if(alllines[k-1][ii][0].length!=0){
        if(allwidth[k-1][ii][0] < lwidth){
          if((alllines[k-1][ii][0][3].y >=(starty-lwidth/2))&&(alllines[k-1][ii][0][3].y <= (starty+lwidth/2)))
          {
            d3.select("#sankiline"+ alllines[k-1][ii][2]+"of"+ alllines[k-1][ii][3])
                      .attr("stroke","yellow")
                      .attr("stroke-opacity",0.6);
            drawlineper(k-1,ii,allwidth[k-1][ii][0],alllines[k-1][ii][0][0].y,alllines[k-1][ii][0][3].y);
          }
        }
        else{
          if((alllines[k-1][ii][0][3].y+allwidth[k-1][ii][0]/2 >=starty)&&(alllines[k-1][ii][0][3].y-allwidth[k-1][ii][0]/2 <= starty))
          {
            d3.select("#sankiline"+ alllines[k-1][ii][2]+"of"+ alllines[k-1][ii][3])
                      .attr("stroke","yellow")
                      .attr("stroke-opacity",0.6);
            drawlineper(k-1,ii,allwidth[k-1][ii][0],alllines[k-1][ii][0][0].y,alllines[k-1][ii][0][3].y);
          }

        }
      }
      }
    }

    function drawlinenext(k,i,lwidth,starty,endy){
      if(k==8)
        return;
      for(var ii = 0;ii < 2500;ii++){
      if(alllines[k+1][ii][0].length!=0){
        if(allwidth[k+1][ii][0] < lwidth){
          if((alllines[k+1][ii][0][0].y >=(endy-lwidth/2))&&(alllines[k+1][ii][0][0].y <= (endy+lwidth/2)))
          {
            d3.select("#sankiline"+ alllines[k+1][ii][2]+"of"+ alllines[k+1][ii][3])
                      .attr("stroke","yellow")
                      .attr("stroke-opacity",0.6);
            drawlinenext(k+1,ii,allwidth[k+1][ii][0],alllines[k+1][ii][0][0].y,alllines[k+1][ii][0][3].y);
          }
        }
        else{
          if((alllines[k+1][ii][0][0].y+allwidth[k+1][ii][0]/2 >=endy)&&(alllines[k+1][ii][0][0].y-allwidth[k+1][ii][0]/2 <= endy))
          {
            d3.select("#sankiline"+ alllines[k+1][ii][2]+"of"+ alllines[k+1][ii][3])
                      .attr("stroke","yellow")
                      .attr("stroke-opacity",0.6);
            drawlinenext(k+1,ii,allwidth[k+1][ii][0],alllines[k+1][ii][0][0].y,alllines[k+1][ii][0][3].y);
          }

        }
      }
      }
    }
    /*for(var k = 0 ; k < attr.length - 1 ; k++){
      for(var i = 0 ; i < 2500 ; i++){
        d3.select("#sankiline"+k+"of"+i)
        .on("click",function(d){
          console.log(k+"of"+i);
          d3.select(this)
            .attr("stroke","yellow");
            for(var ii = 0;i-ii >= 0 ii++){

            }
                  
        });
      }
    }*/


    /*var elem=document.getElementById("btn");
    elem.style.position = "absolute";
    elem.style.left = "17px";
    elem.style.top = "370px";
    elem=document.getElementById("btn1");
    elem.style.position = "absolute";
    elem.style.left = "17px";
    elem.style.top = "395px";*/

    var yflag = true;
    var xflag = true;
    var randflag = false;
    var rorder = [];
    	for(var i = 0;i < attr.length;i++)
    	    rorder[i]=[i];



  function sumBySize(d) {
    return d.size;
  }



  function addchildx(obj){
    if(obj.values == null)
      return;
    obj.children = obj.values;
    delete obj.values;
    for(var i= 0; i < obj.children.length;i++){
      addchildx(obj.children[i]);
    }
  }
  function traverseTree(node,attr,ii){
    if (!node) {
        return;
    }

    //console.log(node);
    if(!node.children){
      var qvalue = 1/node.data.graphcnt*(Math.log(1/node.data.graphcnt)/Math.log(10) )- 2 * ( 1/node.data.graphcnt * (Math.log(1/node.data.graphcnt)/Math.log(10)));
      node.qv[ii] = qvalue;
    }
    else {
      //console.log(qvalue);
      var arr1 = node.leaves();
      var arrcnt = new Array();
      var qvalue = arr1.length/node.graphcnt * (Math.log(arr1.length/node.graphcnt)/Math.log(10));

      for(var j = 0 ; j <= 100 ; j++){
        arrcnt[j] = 0 ;
      }
      for(var j = 0 ; j < arr1.length ; j++){
        if(ii==1)
            arrcnt[arr1[j].data.vip]++;
        else if(ii==0)
            arrcnt[arr1[j].data.city]++;
        else if(ii==2){
            arrcnt[arr1[j].data.sex]++;
          }
        else if(ii==3){
            arrcnt[arr1[j].data.profession]++;
          }
        else if(ii==4){
            arrcnt[arr1[j].data.age]++;
          }
        else if(ii==5){
            arrcnt[arr1[j].data.active]++;
          }
        else if(ii==6){
            arrcnt[parseInt(arr1[j].data.time / 2)]++;
          }
        else if(ii==7){
            arrcnt[arr1[j].data.concern]++;
          }
        else if(ii==8){
            arrcnt[arr1[j].data.beconcern]++;
          }
        else if(ii==9){
            arrcnt[arr1[j].data.area]++;
          }
      }
      for(var j =0 ; j <= 100 ; j++){
        if(arrcnt[j]&&arrcnt[j] > 0)
        qvalue = qvalue - 2 * arrcnt[j]/node.graphcnt * (Math.log(arrcnt[j]/node.graphcnt)/Math.log(10));
      
      }
      //console.log(Math.log(235/2555));
      node.qv[ii] = qvalue;
    }
    cnt++;
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTree(node.children[i],attr,ii);
        }
    }
}
function traverseTreeInit(node){
    if (!node) {
        /*node.qv = new Array();
        for(var i = 0;i<attr.length;i++){
          node.qv.push(0.0);
        }  
        node.cut = new Array(attr.length);
        for(var i = 0;i<attr.length;i++){
          node.cut[i] = new Array();
        }*/
        return;
    }
    node.qv = new Array();
    node.qvold = new Array();
    for(var i = 0;i<attr.length;i++){
          node.qv.push(0.0);
        }
    for(var i = 0;i<attr.length;i++){
          node.qvold.push(0.0);
        }
    node.cut = new Array(attr.length);
    for(var i = 0;i<attr.length;i++){
          node.cut[i] = new Array();
        }
    if(!node.children){
      var falggraph = 0;
      for(var aa = 0;aa < graphs.length;aa++){
        for(var bb = 0;bb<graphs[aa].length;bb++){
          if(node.data.name == graphs[aa][bb]){
              node.data.graphcnt = graphs[aa].length;
              node.data.graphid = aa;
              falggraph=1;
              break;
          }
        }
        if(falggraph) break;
      }
      var rand = Math.random();
      var rand1 = Math.random();
      var rand2 = Math.random();
      var rand3 = Math.random();
      var rand4 = Math.random();

      node.value = 1;


       if(rand < 0.5)
          node.data.sex = 1;
        else
          node.data.sex = 0;

      if(rand < 0.9&&rand > 0.1)
          node.data.vip = 0;
        else
          node.data.vip = 1;


      if(rand < 0.4)
          node.data.age = 1;
        else if(rand < 0.7)
          node.data.age = 0;
        else if(rand < 0.9)
          node.data.age = 2;
        else
          node.data.age = 3;

        if(rand2 < 0.25)
          node.data.active = 2;
        else if(rand2 < 0.45)
          node.data.active = 1;
        else if(rand2 < 0.65)
          node.data.active = 3;
        else if(rand2 < 0.835)
          node.data.active = 0;
        else 
          node.data.active = 4;

        if(rand3 < 0.3)
          node.data.concern = 3;
        else if(rand3 < 0.5)
          node.data.concern = 2;
        else if(rand3 < 0.7)
          node.data.concern = 4;
        else if(rand3 < 0.8)
          node.data.concern = 1;
        else if(rand3 < 0.9)
          node.data.concern = 5;
        else if(rand3 < 0.95)
          node.data.concern = 0;
        else 
          node.data.concern = 6;

        if(rand1 < 0.2)
          node.data.time = 0;
        else if(rand1 < 0.35)
          node.data.time = 1;
        else 
          node.data.time = parseInt(rand *15);


        if(rand1 < 0.3)
          node.data.beconcern = 3;
        else if(rand1 < 0.5)
          node.data.beconcern = 2;
        else if(rand1 < 0.7)
          node.data.beconcern = 4;
        else if(rand1 < 0.8)
          node.data.beconcern = 1;
        else if(rand1 < 0.9)
          node.data.beconcern = 5;
        else if(rand1 < 0.95)
          node.data.beconcern = 0;
        else 
          node.data.beconcern = 6;
        
        if(node.data.profession == 5){
          if(rand4 < 0.3)
            node.data.profession = 4;
          else if(rand4 < 0.55)
            node.data.profession = 2;
          else if(rand4 < 0.75)
            node.data.profession = 1;
          else if(rand4 < 0.875)
            node.data.profession = 0;
          else 
            node.data.profession = 3;
        }

        if(node.data.city <= 4) node.data.area = 0;
        else if(node.data.city <= 7) node.data.area = 1;
        else if(node.data.city <= 14) node.data.area = 2;
        else if(node.data.city <= 20) node.data.area = 3;
        else if(node.data.city <= 25) node.data.area = 4;
        else if(node.data.city <= 30) node.data.area = 5;
        else node.data.area = 6;

        procnt[node.data.profession]++;
    }
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTreeInit(node.children[i]);
        }
    }
}

function graph_cut(obj,attr,ii){
  if(!obj.children){
    obj.cut[ii] = new Array();
    obj.cut[ii].push(obj.id);
    //console.log(obj);
  }
  else{
    var sumqv = 0;
    for(var i=0 ;i < obj.children.length;i++){
      graph_cut(obj.children[i],attr,ii);
      sumqv += obj.children[i].qv[ii];
    }
    if(ii<0){
        
        if(obj.qv[ii]>= sumqv){
          obj.qvold[ii] = obj.qv[ii]
          obj.qv[ii] = sumqv;
          obj.cut[ii] = new Array();
          for(var i=0 ;i < obj.children.length;i++){
           obj.cut[ii] = obj.cut[ii].concat(obj.children[i].cut[ii]);
            //console.log(obj.cut);
         }
        }else{
          obj.cut[ii] = new Array();
          obj.cut[ii].push(obj.id);
        }
    }
    else{
      var rand = Math.random();
      if(obj.leaves().length > 60&&obj.id!=8)
        rand = rand * 8;
      if(obj.id==2)
      	rand = rand * 4;
      if(ii == 0) rand = 1;
      if(ii == 1) rand = rand * 0.5;
      if(ii == 2) rand = rand * 4;
      if(ii == 7) rand = rand * 1.25;
      if(ii == 8) rand = rand * 0.8;
      if(ii == 9) rand = rand * 0.2;
      if(rand > 0.5||(ii==7&&obj.height==2)||(ii==6&&obj.height==2)||(ii==5&&obj.height==2)){
          obj.qvold[ii] = obj.qv[ii]
          obj.qv[ii] = sumqv;
          obj.cut[ii] = new Array();
          for(var i=0 ;i < obj.children.length;i++){
           obj.cut[ii] = obj.cut[ii].concat(obj.children[i].cut[ii]);
            //console.log(obj.cut);
         }
        }else{
          obj.cut[ii] = new Array();
          obj.cut[ii].push(obj.id);
        }
    }
  }
}
  function traverseTreeCut(node,ii){
    if (!node) {
        return;
    }
    if(node.id == finalcut[ii][cnt]){
      var xy = {"x":0 , "y":0};
      var xymid = {"x":0 , "y":0,"miancolor":0};
      xy.x = node.x ;
      xy.y = node.y ;
      alllinedata[ii].push(xy);
      var arr2 = node.leaves();
      xymid.x = (arr2[0].x + arr2[arr2.length-1].x)/2.0;
      xymid.cnt = arr2.length;
      xymid.id = node.id;
      /*var randc = Math.random();
      xymid.miancolor = parseInt(randc *30);*/
      //xymid.y = (arr2[0].y + arr2[arr2.length-1].y)/2.0;


      middle[ii].push(xymid);
      cnt++;
    }
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTreeCut(node.children[i],ii);
        }
    }
}

  function traverseTreeFind(node, ii , zhia ,zhib ){
    if (!node || flag22 ||flag11) {
        return;
    }
    //console.log(finalcut[ii][zhia]);
    if(node.id == finalcut[ii][zhia]){
      var childrens = node.ancestors();
      //console.log(childrens);
      for(var j = 0; j < childrens.length;j++){
        if(childrens[j].id == finalcut[ii + 1][zhib])
          {
            //console.log(childrens[j].id + " " +finalcut[ii + 1][zhib]);
            flag11 = true;
          }
        }
      }
    
    if(node.id == finalcut[ii+1][zhib]){
      var childrens = node.ancestors();
      for(var j = 0; j < childrens.length;j++){
        if(childrens[j].id == finalcut[ii][zhia])
          flag22 = true;
      }
    }
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTreeFind(node.children[i],ii,zhia,zhib);
        }
    }
}
  function traverseTreeFind2(node, ii ,jj, zhia ,zhib ){
    if (!node || flag22 ||flag11) {
        return;
    }
    //console.log(finalcut[ii][zhia]);
    if(node.id == finalcut[ii][zhia]){
      var childrens = node.ancestors();
      //console.log(childrens);
      for(var j = 0; j < childrens.length;j++){
        if(childrens[j].id == finalcut[jj][zhib])
          {
            //console.log(childrens[j].id + " " +finalcut[ii + 1][zhib]);
            flag11 = true;
          }
        }
      }
    
    if(node.id == finalcut[jj][zhib]){
      var childrens = node.ancestors();
      for(var j = 0; j < childrens.length;j++){
        if(childrens[j].id == finalcut[ii][zhia])
          flag22 = true;
      }
    }
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTreeFind2(node.children[i],ii,jj,zhia,zhib);
        }
    }
}
  function traverseTreeCompare(node , numa ,numb,ii,jj ){
    if (!node || flagc2 ||flagc1) {
        return;
    }
    //console.log(finalcut[ii][zhia]);
    if(node.id == numa){
          nodec1 = node;
          //console.log("aaa");
      }
    
    if(node.id == numb){
          nodec2 = node;
          //console.log("bbb");
      
    }
    if(nodec1&&nodec2){
      var pathc = nodec1.path(nodec2);
      flagc1 = true;
      for(var k = 0; k < pathc.length ;k++){
        if(pathc[k].visit == false){
          //console.log(111);
          pathc[k].visit = true;
          cutcnt[ii][jj] = cutcnt[ii][jj]+1;
        }
      }
      //console.log(pathc);
    }
    if (node.children && node.children.length > 0) {
        var i = 0;
        for (i = 0; i < node.children.length; i++) {
          //node.children[i].qv = 0;
            traverseTreeCompare(node.children[i],numa,numb,ii,jj);
        }
    }
}
  function compare_cut(cut,ii,jj){
    //cutcnt[ii][jj] = 0;
    //console.log(cutcnt);
    for(var i = 0; i < cut.length ;i++){
      if(cut[i].source == cut[i].target) continue;
      nodec1 = null;
      nodec2 = null;
      traverseTreeCompare(hie ,cut[i].source,cut[i].target,ii,jj);
      flagc1 = false;
      //console.log(cutcnt);
    }
  }

  function find_cut(node,attr,i){
    traverseTree(node,attr,i);
    cnt=0;
    graph_cut(node,attr,i);
  }
});


</script>